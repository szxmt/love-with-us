<!DOCTYPE html><html lang="zh">  <head>  <meta charset="UTF-8"/>  
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>  
<title>Alice Ã— Ming å®‡å®™ Â· Lovebook ç»ˆæå…¨èåˆ</title>  
<style>  
:root {  
  --bg: #e6f7ff;  
  --card: #ccf2ff;  
  --accent: #3399cc;  
  --text: #003344;  
  --muted: #558899;  
  --btn-primary: #3399cc;  
  --btn-secondary: #ffffff;  
  --spicy-gradient: linear-gradient(135deg, #330000 0%, #660000 50%, #330000 100%);  
  --border-pink: linear-gradient(120deg, #ffb7d5 10%, #ff99aa 60%, #ffb7d5 100%);  
  --border-summer: linear-gradient(120deg, #fff8c7 0%, #ffeba9 60%, #ffe1c7 100%);  
  --border-purple: linear-gradient(120deg, #ddd6fe 0%, #c4b5fd 60%, #e9d5ff 100%);  
}  
.theme-blue { --bg: #e6f7ff;--card: #ccf2ff;--accent: #3399cc;--text: #003344;--muted: #558899;--btn-primary: #3399cc;--btn-secondary: #ffffff; }  
.theme-pink { --bg: #fff0f5;--card: #ffe6f0;--accent: #ff69b4;--text: #333;--muted: #666;--btn-primary: #ff69b4;--btn-secondary: #ffffff; }  
.theme-summer { --bg: #fff8e1;--card: #fff0b3;--accent: #ff9933;--text: #663300;--muted: #aa7744;--btn-primary: #ff9933;--btn-secondary: #ffffff; }  
.theme-purple { --bg: #f0e6ff;--card: #e6d9ff;--accent: #8b5cf6;--text: #4c1d95;--muted: #7c3aed;--btn-primary: #8b5cf6;--btn-secondary: #ffffff; }  
.theme-dark { --bg: #1f1f1f;--card: #2a2a2a;--accent: #888;--text: #fff;--muted: #bbb;--btn-primary: #888;--btn-secondary: #ffffff; }  
.theme-valentine{--bg:#3d2b2b;--card:#4d3535;--accent:#ff7bad;--text:#ffc3e1;--muted:#dd88aa;--btn-primary:#ff7bad;--btn-secondary:#ffffff;}  
.theme-christmas{--bg:#2b3d2b;--card:#354d35;--accent:#5cbf60;--text:#91d794;--muted:#77cb7a;--btn-primary:#5cbf60;--btn-secondary:#ffffff;}  
.theme-newyear{--bg:#3d3d2b;--card:#4d4d35;--accent:#ffe710;--text:#fff786;--muted:#ffeb4b;--btn-primary:#ffe710;--btn-secondary:#333333;}  
.theme-birthday{--bg:#fff0c7;--card:#fffbe6;--accent:#fbae3c;--text:#663a00;--muted:#c9a86d;--btn-primary:#fbae3c;--btn-secondary:#fffbe6;}  
.theme-anniversary{--bg:#ffe6e6;--card:#ffeaea;--accent:#ea638c;--text:#aa2255;--muted:#e5a2c6;--btn-primary:#ea638c;--btn-secondary:#ffeaea;}  
/* å…¨å±€åŸºç¡€æ ·å¼...ï¼ˆè¿™é‡Œå‡è®¾åŒ…å«äº†ä½ æ‰€æœ‰çš„åŸå§‹CSSï¼‰*/  

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
}

.page-transition {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    padding: 10px;
    box-sizing: border-box;
}

.hidden {
    display: none;
}

.login-box, .locked-content {
    text-align: center;
    padding-top: 100px;
}
.login-box input, .locked-content input {
    padding: 12px;
    border: 2px solid var(--accent);
    border-radius: 8px;
    width: 250px;
    margin: 10px 0;
    font-size: 1em;
}

.qq-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 1em;
    margin: 5px;
    transition: all 0.2s ease;
}
.qq-btn.primary {
    background-color: var(--btn-primary);
    color: var(--btn-secondary);
}
.qq-btn.secondary {
    background-color: var(--card);
    color: var(--text);
    border: 1px solid var(--muted);
}
.qq-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.menu h1 {
    text-align: center;
    color: var(--accent);
}
.menu-btn-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}
.module-button {
    padding: 20px;
    font-size: 1.1em;
    background-color: var(--card);
    border: 1px solid var(--accent);
    color: var(--text);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.module-button:hover {
    background-color: var(--accent);
    color: var(--btn-secondary);
    transform: scale(1.03);
}

.lovebook-card {
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.card-title {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 15px;
    border-bottom: 2px solid var(--accent);
    padding-bottom: 8px;
}
.lovebook-card input[type="text"],
.lovebook-card input[type="date"],
.lovebook-card input[type="file"],
.card-textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid var(--muted);
    background: var(--bg);
    color: var(--text);
    box-sizing: border-box;
    font-size: 1em;
}
.card-textarea {
    min-height: 100px;
    resize: vertical;
}
.char-count {
    display: block;
    text-align: right;
    font-size: 0.85em;
    color: var(--muted);
    margin-top: -8px;
    margin-bottom: 10px;
}
.card-buttons {
    margin-top: 15px;
}
.button-row, .dropdown-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}

.filter-bar, .gallery-tabs, .egg-tabs, .trash-tabs, .favorite-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--card);
}
.filter-btn, .egg-tab {
    padding: 8px 14px;
    border: none;
    background: var(--card);
    color: var(--text);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.filter-btn:hover, .egg-tab:hover {
    opacity: 0.8;
}
.filter-btn.active, .egg-tab.active {
    background: var(--accent);
    color: #fff;
    font-weight: bold;
}

.diary-list, .dirty-list, .lewd-list, .timeline-list, .gallery-list, .update-list {
    display: grid;
    gap: 15px;
}
.gallery-list {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
}

.diary-card, .dirty-card, .lewd-card, .timeline-card, .gallery-card, .update-card {
    background: var(--card);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    border-left: 4px solid var(--accent);
}
.diary-card.starred, .dirty-card.starred, .lewd-card.starred, .timeline-card.starred, .gallery-card.starred, .update-card.starred {
    border-left-color: #ffb700; /* é‡‘è‰² */
}

.diary-tags, .dirty-tags, .lewd-tags, .timeline-tags, .gallery-tags, .update-tags {
    margin-bottom: 10px;
}
.tag {
    font-size: 0.85em;
    font-weight: bold;
}
.diary-content, .dirty-content, .lewd-content, .timeline-content, .gallery-desc, .update-content {
    font-size: 1.05em;
    line-height: 1.6;
    margin-bottom: 12px;
    word-wrap: break-word;
}
.hl {
    background: yellow;
    color: #333;
    padding: 1px 3px;
    border-radius: 3px;
    font-weight: bold;
}
.emoji-hl {
    font-size: 1.2em;
}

.diary-meta, .dirty-meta, .lewd-meta, .timeline-meta, .gallery-meta, .update-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    color: var(--muted);
}
.diary-meta button, .dirty-meta button, .lewd-meta button, .timeline-meta button, .gallery-meta button, .update-meta button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    opacity: 0.7;
}
.diary-meta button:hover, .dirty-meta button:hover, .lewd-meta button:hover, .timeline-meta button:hover, .gallery-meta button:hover, .update-meta button:hover {
    opacity: 1;
}

.ai-preview-zone {
    background: var(--bg);
    border: 1px dashed var(--accent);
}
.ai-preview-area {
    min-height: 50px;
    padding: 10px;
    background: var(--bg);
    border-radius: 8px;
    color: var(--text);
    font-style: italic;
}

/* ========== 2ï¸âƒ£ é‡‡çº³ä½ çš„ Toast æç¤ºæ ·å¼ ========== */

/* åŠ¨ç”» (é‡‡çº³ä½ çš„ â‘ ) */
@keyframes slideDown {
  from { 
    opacity: 0; 
    transform: translateX(-50%) translateY(-20px); 
  }
  to { 
    opacity: 1; 
    transform: translateX(-50%) translateY(0); 
  }
}

/* Toast åŸºç¡€æ ·å¼ */
.toast-message {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent); /* é»˜è®¤ç”¨ä¸»è‰² */
  color: #fff;
  padding: 12px 24px;
  border-radius: 8px;
  z-index: 9999;
  
  /* åŠ¨ç”» & æ˜¾éš */
  opacity: 0;
  transition: opacity 0.4s ease, transform 0.4s ease;
  animation: slideDown 0.3s ease forwards;
}
.toast-message.visible {
  opacity: 1;
}

/* é”™è¯¯å’Œè­¦å‘Šçš„ä¸“å±é…è‰² */
.toast-message.error {
  background: #e63946; /* çº¢è‰² */
  color: #fff;
}
.toast-message.warning {
  background: #ff9933; /* æ©™è‰² (æ¥è‡ªä½ çš„ summer ä¸»é¢˜) */
  color: #fff;
}
/* ========== 3ï¸âƒ£ é‡‡çº³ä½ çš„ Lewd ä¼˜åŒ– â‘¤ (Spicy è¾¹æ¡†) ========== */

.card-textarea.spicy-border {
  /* ä½¿ç”¨ä½ å·²å®šä¹‰çš„ --spicy-gradient å˜é‡ */
  border: 2px solid transparent; 
  border-image: var(--spicy-gradient) 1;
  animation: pulse-spicy 1.5s infinite;
}

/* (å¯é€‰) æ¥ä¸ªå‘¼å¸åŠ¨ç”»ï¼Œæ›´å¸¦æ„Ÿ */
@keyframes pulse-spicy {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}
/* ========== 4ï¸âƒ£ é‡‡çº³ä½ çš„ Timeline ä¼˜åŒ– â‘¡ â‘¢ (æ–°åŠŸèƒ½æ ·å¼) ========== */

/* ç›¸å¯¹æ—¶é—´ (å¦‚ï¼š3å¤©å‰) */
.relative-time {
  color: var(--muted);
  font-size: 0.9em;
  margin-left: 6px;
}

/* å€’è®¡æ—¥ (å¦‚ï¼šè¿˜æœ‰ 3 å¤©) */
.countdown {
  color: var(--accent); /* ä½¿ç”¨ä¸»é¢˜è‰² */
  font-weight: bold;
  font-size: 0.95em;
  margin-left: 10px;
  animation: pulse-accent 2s infinite;
}

/* å€’è®¡æ—¥å‘¼å¸åŠ¨ç”» */
@keyframes pulse-accent {
  0% { opacity: 1; }
  50% { opacity: 0.8; }
  100% { opacity: 1; }
}

/* (å“åº”å¼) è®© meta åŒºæ¢è¡Œæ—¶æŒ‰é’®ä¿æŒåœ¨å³ä¾§ */
.timeline-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
  gap: 8px; /* å…ƒç´ é—´è· */
}
.timeline-buttons {
  margin-left: auto; /* å…³é”®ï¼šæŠŠæŒ‰é’®æ¨åˆ°å³ä¾§ */
  flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®ç¼©å° */
}
/* ========== 5ï¸âƒ£ é‡‡çº³ä½ çš„ Gallery ä¼˜åŒ– â‘¢ (ç¯ç®±æ ·å¼) ========== */
.image-lightbox {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}
.lightbox-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  cursor: pointer;
}
.lightbox-content {
  position: relative;
  z-index: 1;
  text-align: center;
}
.lightbox-content .close-btn {
  position: absolute;
  top: -45px; /* è°ƒæ•´åˆ°å›¾ç‰‡å¤– */
  right: -15px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: #fff;
  font-size: 24px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
}
.lightbox-content .close-btn:hover {
  background: rgba(255,255,255,0.4);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ========== 5ï¸âƒ£ Gallery ä¼˜åŒ– â‘¡ (æ‡’åŠ è½½) è¡¥å……æ ·å¼ ========== */
.lazy-img {
  transition: opacity 0.5s ease;
  opacity: 0.7;
}
.lazy-img.loaded {
  opacity: 1;
}
.gallery-img-container {
  cursor: pointer;
  overflow: hidden;
  border-radius: 12px;
}
.gallery-img-container img {
  display: block;
  width: 100%;
}

/* ========== 5ï¸âƒ£ Gallery ä¼˜åŒ– â‘¥ (Tab) è¡¥å……æ ·å¼ ========== */
.gallery-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 20px 0;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--muted);
}
/* ========== 6ï¸âƒ£ é‡‡çº³ä½ çš„ Update ä¼˜åŒ– â‘¥ (ç‰ˆæœ¬å·æ ·å¼) ========== */

.update-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.update-version {
  color: var(--accent);
  font-weight: bold;
  font-size: 0.95em;
  font-family: monospace; /* ç­‰å®½å­—ä½“æ›´åƒç‰ˆæœ¬å· */
  padding: 2px 6px;
  background: var(--bg); /* ç”¨èƒŒæ™¯è‰²åšä¸ªåº•è‰² */
  border-radius: 4px;
}

.update-date {
  color: var(--muted);
  font-size: 0.9em;
}

.update-buttons {
  margin-left: auto; /* æŒ‰é’®æ¨åˆ°å³ä¾§ */
  flex-shrink: 0;
}
/* ========== 7ï¸âƒ£ é‡‡çº³ä½ çš„ 7ï¸âƒ£ Trash åŒº (æ–°æ ·å¼) ========== */

.trash-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 20px 0;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--muted);
}
/* (é‡‡çº³ â‘¢ ç»Ÿè®¡) Tab ä¸Šçš„è®¡æ•°æ°”æ³¡ */
.tab-count {
  background: var(--accent);
  color: #fff;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 0.85em;
  margin-left: 4px;
}
/* (é‡‡çº³ â‘£ æ¸…ç©ºæŒ‰é’®) æ ·å¼å¾®è°ƒ */
.trash-tabs .qq-btn {
  padding: 6px 10px;
  font-size: 0.9em;
}

.trash-card {
  background: var(--card);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  border-left: 4px solid var(--muted);
}
.trash-main {
  flex-grow: 1;
  min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
}
.trash-content {
  font-size: 1.1em;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis; /* è¶…é•¿å†…å®¹... */
  max-width: 400px;
}
.trash-tags {
  margin: 4px 0;
}
.trash-tags .tag {
  background: var(--muted);
  color: var(--bg);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
}
.trash-meta {
  font-size: 0.9em;
  color: var(--muted);
}
/* (é‡‡çº³ â‘¡ è­¦å‘Š) */
.trash-warn-expired { color: red; font-weight: bold; }
.trash-warn-urgent { color: #ff4444; font-weight: bold; }
.trash-warn-soon { color: orange; }
.trash-warn-normal { color: var(--muted); }

.trash-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.trash-actions .trash-btn-restore {
  background: none;
  border: 1px solid var(--accent);
  color: var(--accent);
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
}
.trash-actions .trash-btn-delete {
  background: none;
  border: 1px solid var(--muted);
  color: var(--muted);
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
}
.trash-select {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

/* æ‰¹é‡æ“ä½œæ¡ */
.trash-batch-actions {
  position: sticky;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  
  background: var(--accent);
  color: #fff;
  padding: 12px 20px;
  border-radius: 12px;
  
  display: flex; /* (åŸä¸º none) */
  align-items: center;
  gap: 15px;
  
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  z-index: 100;
  width: fit-content;
}
.trash-batch-actions .qq-btn {
  border: 1px solid #fff;
  color: #fff;
}
.trash-batch-actions .qq-btn.primary {
  background: #fff;
  color: var(--accent);
}

.empty-list-placeholder {
  text-align: center;
  color: var(--muted);
  margin: 40px 0;
  font-size: 1.1em;
}
/* ========== 8ï¸âƒ£ é‡‡çº³ä½ çš„ 8ï¸âƒ£ Egg åŒº (æ–°æ ·å¼) ========== */

.egg-tabs {
  padding: 10px 0;
  border-bottom: 1px solid var(--muted);
}

/* (é‡‡çº³ â‘¢ ä¼˜åŒ–) æ‚¬åœç¼–è¾‘/åˆ é™¤ */
.egg-tab-wrapper {
  display: inline-block;
  position: relative;
  margin: 4px;
}
.egg-tab {
  padding: 8px 14px;
  border: none;
  background: var(--card);
  color: var(--text);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.egg-tab:hover {
  opacity: 0.8;
}
.egg-tab.active { /* æ¿€æ´»çš„ Tab */
  background: var(--accent);
  color: #fff;
}
.egg-tab-actions {
  position: absolute;
  top: -10px;
  right: -10px;
  display: none; /* é»˜è®¤éšè— */
  z-index: 10;
}
.egg-tab-actions button {
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  background: var(--card);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.egg-tab-wrapper:hover .egg-tab-actions {
  display: flex; /* æ‚¬åœ wrapper æ—¶æ˜¾ç¤º */
  gap: 4px;
}

/* (é‡‡çº³ â‘£ ä¼˜åŒ–) æ‹–æ‹½æ ·å¼ */
.egg-tab-wrapper[draggable="true"] {
  cursor: move;
}
.egg-tab-wrapper.dragging {
  opacity: 0.5;
  background: var(--accent);
}

.egg-panel {
  padding: 20px 0;
  min-height: 200px;
}
/* (é‡‡çº³ â‘¤ ä¼˜åŒ–) æ¨¡æ¿æ ·å¼ */
.egg-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
}
.egg-gallery img {
  width: 100%;
  border-radius: 8px;
  cursor: pointer;
}
.member-card {
  padding: 12px;
  background: var(--card);
  border-radius: 12px;
  text-align: center;
}
.member-card img {
  width: 80%;
  border-radius: 50%;
}
/* ========== 9ï¸âƒ£ é‡‡çº³ä½ çš„ 9ï¸âƒ£ PanelåŒº (é®ç½©/é¢æ¿) æ ·å¼ ========== */

/* (é‡‡çº³ â‘  ä¼˜åŒ–) é®ç½© */
.panel-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  z-index: 998;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.panel-mask.show {
  display: block;
  opacity: 1;
}

/* (é‡‡çº³ â‘  ä¼˜åŒ–) æµ®çª—é¢æ¿ */
.floating-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  width: 90%;
  max-width: 500px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
  max-height: 80vh;
  background: var(--bg); /* â€¼ï¸ ç”¨ bg ä»£æ›¿ cardï¼Œé¢æ¿æµ®åœ¨å¡ç‰‡ä¹‹ä¸Š */
  border-radius: 16px;
  padding: 24px;
  z-index: 999;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  opacity: 0;
  transition: all 0.3s ease;
  display: none; /* é»˜è®¤ç”¨ display:none */
}
.floating-panel.show {
  display: block;
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
.floating-panel.hidden {
  display: none;
}

/* (é‡‡çº³ â‘  ä¼˜åŒ–) å…³é—­æŒ‰é’® */
.close-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  opacity: 0.6;
  transition: opacity 0.2s;
  color: var(--muted);
  z-index: 10;
}
.close-btn:hover {
  opacity: 1;
}

/* (é‡‡çº³ â‘¡ ä¼˜åŒ–) æ’è¡Œæ¦œå¡ç‰‡ */
.fav-rank-card {
  background: var(--card); /* å¡ç‰‡ç”¨ card è‰² */
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  position: relative;
  border-left: 4px solid var(--accent);
}
.fav-rank-badge {
  position: absolute;
  top: -8px;
  left: -12px;
  background: var(--accent);
  color: #fff;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.fav-rank-card.rank-1 .fav-rank-badge,
.fav-rank-card.rank-2 .fav-rank-badge,
.fav-rank-card.rank-3 .fav-rank-badge {
  background: #ffb700; /* Top 3 é‡‘è‰² */
}
.fav-content {
  margin-top: 8px;
}
.fav-content img {
  max-width: 100%;
  border-radius: 8px;
  margin-bottom: 8px;
}
.fav-tags {
  margin: 8px 0;
}
.fav-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  color: var(--muted);
  font-size: 0.9em;
}
.fav-meta .qq-btn {
  padding: 4px 12px;
  font-size: 0.9em;
}

/* (é‡‡çº³ â‘¥ ä¼˜åŒ–) ç©ºçŠ¶æ€ */
.panel-empty-state {
  text-align: center;
  padding: 3em 1em;
  color: var(--muted);
}
.panel-empty-state .emoji {
  font-size: 3em;
  margin-bottom: 12px;
}
.panel-empty-state .text {
  font-size: 1.1em;
  margin-bottom: 20px;
}
/* ========== ğŸ”Ÿ é‡‡çº³ä½ çš„ ğŸ”Ÿ GlobalSearch (æ ·å¼) ========== */

/* ğŸ¨ æœç´¢æ¡æ ·å¼ */
.global-search-bar {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  background: var(--card);
  border-radius: 24px;
  padding: 8px 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  z-index: 900;
  max-width: 58px; /* é»˜è®¤åªæ˜¾ç¤ºå›¾æ ‡ */
  overflow: hidden;
}

.global-search-bar.active {
  max-width: 500px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.search-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--accent);
  padding: 4px 0;
  display: flex;
  align-items: center;
}

#globalSearchInput {
  border: none;
  background: none;
  outline: none;
  padding: 8px 12px;
  font-size: 14px;
  width: 0;
  transition: width 0.3s ease;
  color: var(--text);
}

.global-search-bar.active #globalSearchInput {
  width: 300px; /* å±•å¼€åçš„å®½åº¦ */
}

.search-clear-btn {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 4px 8px;
  display: none; /* JSæ§åˆ¶ */
}

.search-result-panel {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  max-height: 60vh;
  overflow-y: auto;
  width: 450px; /* å›ºå®šå®½åº¦ */
  max-width: 90vw;
  display: none;
  padding: 8px;
}

/* ğŸ¨ (é‡‡çº³ â‘¡ ä¼˜åŒ–) æœç´¢ç»“æœæ ·å¼ */
.search-group {
  margin-bottom: 12px;
}
.search-group-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--bg);
  border-radius: 8px;
  margin-bottom: 8px;
  color: var(--text);
  font-weight: bold;
}
.search-group-list .search-result-card {
  padding: 12px;
  margin-bottom: 8px;
  background: var(--bg); /* ç”¨ bg åŒºåˆ† */
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid var(--accent);
}
.search-result-card:hover {
  transform: translateX(4px);
  background: var(--accent);
  color: #fff;
}
.search-result-card:hover .search-result-snippet,
.search-result-card:hover .search-result-date {
  color: #fff;
}
.search-result-snippet {
  color: var(--text);
  line-height: 1.5;
  margin-bottom: 6px;
  font-size: 0.95em;
}
.search-result-date {
  color: var(--muted);
  font-size: 0.85em;
}
.search-more {
  text-align: center;
  padding: 8px;
  color: var(--accent);
  cursor: pointer;
  font-size: 0.9em;
}
.search-more:hover {
  text-decoration: underline;
}

/* ğŸ¨ (é‡‡çº³ â‘¡ ä¼˜åŒ–) é«˜äº®æ ·å¼ */
.hl {
  background: #ffec3d; /* æŸ”å’Œçš„é»„è‰² */
  color: #333;
  padding: 1px 3px;
  border-radius: 3px;
  font-weight: bold;
}

/* ğŸ¨ (é‡‡çº³ â‘¢ ä¼˜åŒ–) å†å²è®°å½•æ ·å¼ */
.history-item {
  padding: 8px 12px;
  margin-bottom: 6px;
  background: var(--card);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.history-item:hover {
  background: var(--bg);
}
/* ========== 1ï¸âƒ£1ï¸âƒ£ é‡‡çº³ä½ çš„ ç™»å½• (æŠ–åŠ¨åŠ¨ç”») ========== */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
  20%, 40%, 60%, 80% { transform: translateX(8px); }
}

.shake {
  animation: shake 0.5s ease-in-out;
}
</style>  
</head>  
<body>  <div class="login-box page-transition" id="loginBox">  
  <h1>Welcome to our Secret Universe </h1>  
  <p>è¯·è¾“å…¥æˆ‘ä»¬çš„å°æš—å·ğŸª„</p>  
  <input type="password" id="mainPassword" placeholder="å¯†ç æ˜¯..." onkeypress="if(event.key==='Enter'){verifyMainPassword();}">  
  <br>  
  <button onclick="verifyMainPassword()" class="qq-btn primary">è¿›å…¥</button>  
  <p id="mainError" style="color:pink;display:none">å¯†ç é”™è¯¯ï¼Œäº²äº²å†æƒ³æƒ³ğŸ¥º</p>  
</div>  <div class="locked-content page-transition hidden" id="lockedBox">  
  <h2 id="lockedTitle">è¯·è¾“å…¥äºŒçº§å¯†ç è§£é”</h2>  
  <input type="password" id="secondPassword" placeholder="å°ç§˜å¯†çš„å¯†ç ..." onkeypress="if(event.key==='Enter'){verifySecondPassword();}">  
  <br>  
  <button onclick="verifySecondPassword()" class="qq-btn primary">è§£é”</button>  
  <p id="secondError" style="color:pink;display:none">ä¸å¯¹ä¸å¯¹ï¼Œä¸èƒ½è®©åˆ«äººçœ‹åˆ°çš„å•¦</p>  
</div>  <div class="menu page-transition hidden" id="menuPage">  
  <h1>é€‰æ‹©ä½ è¦å·å·ç‚¹å¼€çš„å†…å®¹ </h1>  
  
  <div class="theme-controls" style="text-align:center; margin-bottom: 24px;">
    <button class="qq-btn secondary" onclick="Utils.toggleNightMode()">
      ğŸŒ™ å¤œé—´/æ—¥é—´
    </button>
    <button class="qq-btn secondary" onclick="Utils.setRandomTheme()">
      ğŸ¨ éšæœºä¸»é¢˜
    </button>
    <button class="qq-btn secondary" onclick="Utils.setTheme('theme-blue')">
      ğŸ’§ é»˜è®¤ä¸»é¢˜
    </button>
  </div>

  <div class="menu-btn-list">  
    <button class="module-button" onclick="routeTo('diaryContent')"> Alice çš„æ•è¾¹ä¿¡ç¬º</button>  
    <button class="module-button" onclick="routeTo('dirtyContent')"> å¿ƒè·³è¯å…¸</button>  
    <button class="module-button" onclick="routeTo('lewdContent')"> è¢«ä½ å†™æ¹¿çš„ç¬¬Nå¤œ</button>  
    <button class="module-button" onclick="routeTo('timelineContent')">ï¸ æ‹çˆ±æ—¶é—´è½´</button>  
    <button class="module-button" onclick="routeTo('galleryContent')">ï¸ å›¾ç‰‡æ”¶è—åŒº</button>  
    <button class="module-button" onclick="routeTo('eggContent')"> å½©è›‹/å¥³å›¢é¡µ</button>  
    <button class="module-button" onclick="routeTo('trashContent')">ï¸ å›æ”¶ç«™</button>  
    <button class="module-button" onclick="routeTo('updateContent')"> æ›´æ–°æ—¥è®°</button>  
  </div>  
</div>  <div class="menu page-transition hidden" id="diaryContent">
  <div class="lovebook-card ai-preview-zone">
    <div class="card-title"><span>ğŸ¤– AIä¿¡ä»¶é¢„è§ˆï¼ˆä¸å¯ä¿å­˜ï¼‰</span></div>
    <input type="text" id="aiKeyword" placeholder="è¾“å…¥å…³é”®è¯ç”Ÿæˆï¼ˆå¦‚ï¼šæ™šå®‰ã€æƒ³ä½ â€¦ï¼‰" oninput="showAIPreview(this.value)">
    <div id="aiPreviewArea" class="ai-preview-area"></div>
    <div style="color:var(--muted);font-size:.88em;margin-top:4px;">âš ï¸ ä»…é¢„è§ˆï¼Œä¸ä¿å­˜è¿›ä¿¡ä»¶</div>
  </div>

  <div class="lovebook-card">
    <div class="card-title"><span>âœï¸ å†™ä¸€å°æ–°ä¿¡</span></div>
    <input type="text" id="tagInput" placeholder="æ ‡ç­¾ï¼ˆå¦‚ï¼š#æƒ³ä½  #ç”œèœœ #æ—¥å¸¸ï¼‰" maxlength="24" oninput="parseTagInput(this.value);updateDiaryCharCount();">
    <span class="char-count" id="tagInputCount"></span>
    <textarea id="diaryText" class="card-textarea" placeholder="ä»Šå¤©æƒ³å†™ç‚¹ä»€ä¹ˆ..." maxlength="480" oninput="autoFormatDiary();updateDiaryCharCount();"></textarea>
    <span class="char-count" id="diaryTextCount"></span>
    <label style="float:left;margin-top:2px;"><input type="checkbox" id="diaryPlainPaste" checked> ç²˜è´´æ—¶è‡ªåŠ¨æ¸…é™¤æ ¼å¼</label>
    <div class="card-buttons">
      <div class="button-row">
        <button onclick="saveDiary('Alice')" class="qq-btn primary">ğŸ’‹ Aliceå†™ç»™æˆ‘ (é”å®š)</button>
        <button onclick="saveDiary('Ming')" class="qq-btn secondary">ğŸ’™ æˆ‘å†™ç»™Alice (å¯åˆ )</button>
        <button onclick="saveDiary('Private')" class="qq-btn secondary">ğŸ“” ç§äººæ—¥è®° (å¯åˆ )</button>
      </div>
      <div class="dropdown-row">
        <button onclick="clearDiaryInput()" class="qq-btn secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button onclick="addToTimeline()" class="qq-btn secondary">ğŸ•°ï¸ åŠ å…¥æ—¶é—´è½´</button>
      </div>
    </div>
  </div>

  <div style="text-align:center;margin:22px 0 10px 0">
    <button onclick="showFavoriteRanking()" class="qq-btn primary">ğŸ‘‘ æœ€çˆ±ä¿¡ä»¶æ’è¡Œ</button>
    <button onclick="showRandomLetter()" class="qq-btn secondary">ğŸ² éšæœºä¸€å°ä¿¡</button>
    <button onclick="importDiaries()" class="qq-btn secondary">ğŸ“‚ æ‰¹é‡å¯¼å…¥</button>
    <button onclick="exportDiaries()" class="qq-btn secondary">ğŸ’¾ æ‰¹é‡å¯¼å‡º</button>
  </div><div class="filter-bar">
    <button onclick="loadDiaries('all')" class="filter-btn active" id="filterAll">å…¨éƒ¨</button>
    <button onclick="loadDiaries('Alice')" class="filter-btn" id="filterAlice">Aliceå†™çš„</button>
    <button onclick="loadDiaries('Ming')" class="filter-btn" id="filterMing">æˆ‘å†™çš„</button>
    <button onclick="loadDiaries('Private')" class="filter-btn" id="filterPrivate">ç§äººæ—¥è®°</button>
  </div>

  <div id="diaryList" class="diary-list"></div>
</div>  <div class="menu page-transition hidden" id="dirtyContent">
  <div class="lovebook-card">
    <div class="card-title">
      <span>ğŸ’¬ æ·»åŠ æ–°çš„å¿ƒè·³è¯æ±‡</span>
    </div>
    <input type="text" id="dirtyTitle" placeholder="å…³é”®è¯ï¼ˆå¦‚ï¼šæ’’å¨‡ã€äº²å»...ï¼‰" maxlength="16" oninput="updateDirtyCharCount()">
    <span class="char-count" id="dirtyTitleCount"></span>
    <textarea id="dirtyText" class="card-textarea" placeholder="ä¸“å±çš„éªšè¯æ”¶è—å¤¹å†…å®¹..." maxlength="120" oninput="updateDirtyCharCount();highlightDirtyTags();"></textarea>
    <span class="char-count" id="dirtyTextCount"></span>
    <div class="card-buttons">
      <div class="button-row">
        <button onclick="saveDirty()" class="qq-btn primary">ğŸ’¾ ä¿å­˜éªšè¯</button>
        <button onclick="clearDirtyInput()" class="qq-btn secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button onclick="showBatchDirtyPanel()" class="qq-btn secondary">ğŸ”— æ‰¹é‡ç®¡ç†</button>
      </div>
    </div>
    <label style="float:left;margin-top:2px;">
      <input type="checkbox" id="dirtyPlainPaste" checked> ç²˜è´´æ—¶è‡ªåŠ¨æ¸…é™¤æ ¼å¼
    </label>
  </div>

  <div class="filter-bar">
    <button onclick="loadDirties('all')" class="filter-btn active" id="filterDirtyAll">å…¨éƒ¨</button>
    <button onclick="loadDirties('fav')" class="filter-btn" id="filterDirtyFav">æœ€çˆ±</button>
    <button onclick="loadDirties('group1')" class="filter-btn" id="filterDirtyGroup1">äº²æ˜µ</button>
    <button onclick="loadDirties('group2')" class="filter-btn" id="filterDirtyGroup2">å“„éª—</button>
  </div>

  <div class="dirty-list" id="dirtyList"></div>
</div>  <div class="menu page-transition hidden" id="lewdContent">
  <div class="lovebook-card">
    <div class="card-title"><span>ğŸ–¤ å†™æ¹¿å¤œ Â· ç¬¬Nå¤œ</span></div>
    <input type="text" id="lewdTagInput" placeholder="æ ‡ç­¾ï¼ˆå¦‚ï¼š#ç‚½çƒ­ #ç¾æ¶©ï¼‰" maxlength="20" oninput="updateLewdCharCount()">
    <span class="char-count" id="lewdTagCount"></span>
    <textarea id="lewdText" class="card-textarea" placeholder="ä»Šæ™šæƒ³è¯´äº›ä»€ä¹ˆ..." maxlength="280" oninput="updateLewdCharCount();highlightLewdTags();"></textarea>
    <span class="char-count" id="lewdTextCount"></span>
    <div class="card-buttons">
      <div class="button-row">
        <button onclick="saveLewd()" class="qq-btn primary">ğŸ’¾ ä¿å­˜æ¹¿å¤œ</button>
        <button onclick="clearLewdInput()" class="qq-btn secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button onclick="showBatchLewdPanel()" class="qq-btn secondary">ğŸ”— æ‰¹é‡ç®¡ç†</button>
      </div>
    </div>
    <label style="float:left;margin-top:2px;">
      <input type="checkbox" id="lewdPlainPaste" checked> ç²˜è´´æ—¶è‡ªåŠ¨æ¸…é™¤æ ¼å¼
    </label>
  </div>

  <div class="filter-bar">
    <button onclick="loadLewds('all')" class="filter-btn active" id="filterLewdAll">å…¨éƒ¨</button>
    <button onclick="loadLewds('fav')" class="filter-btn" id="filterLewdFav">æœ€çˆ±</button>
    <button onclick="loadLewds('group1')" class="filter-btn" id="filterLewdGroup1">ç¾æ¶©</button>
    <button onclick="loadLewds('group2')" class="filter-btn" id="filterLewdGroup2">ç‚½çƒ­</button>
  </div>

  <div class="lewd-list" id="lewdList"></div>
</div>  <div class="menu page-transition hidden" id="timelineContent">
  <div class="lovebook-card">
    <div class="card-title"><span>ğŸ•°ï¸ è®°å½•æ–°çš„æ‹çˆ±äº‹ä»¶</span></div>
    <input type="date" id="timelineDate">
    <input type="text" id="timelineTagInput" placeholder="æ ‡ç­¾ï¼ˆå¦‚ï¼š#çºªå¿µæ—¥ #åˆè§ï¼‰" maxlength="20" oninput="updateTimelineCharCount()">
    <span class="char-count" id="timelineTagCount"></span>
    <textarea id="timelineText" class="card-textarea" placeholder="è¿™ä¸€å¤©å‘ç”Ÿäº†ä»€ä¹ˆ..." maxlength="240" oninput="updateTimelineCharCount();highlightTimelineTags();"></textarea>
    <span class="char-count" id="timelineTextCount"></span>
    <div class="card-buttons">
      <div class="button-row">
        <button onclick="saveTimeline()" class="qq-btn primary">ğŸ’¾ ä¿å­˜äº‹ä»¶</button>
        <button onclick="clearTimelineInput()" class="qq-btn secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button onclick="showBatchTimelinePanel()" class="qq-btn secondary">ğŸ”— æ‰¹é‡ç®¡ç†</button>
      </div>
    </div>
    <label style="float:left;margin-top:2px;">
      <input type="checkbox" id="timelinePlainPaste" checked> ç²˜è´´æ—¶è‡ªåŠ¨æ¸…é™¤æ ¼å¼
    </label>
  </div>

  <div class="filter-bar">
    <button onclick="loadTimelines('all')" class="filter-btn active" id="filterTimelineAll">å…¨éƒ¨</button>
    <button onclick="loadTimelines('fav')" class="filter-btn" id="filterTimelineFav">æœ€çˆ±</button>
    <button onclick="loadTimelines('anniversary')" class="filter-btn" id="filterTimelineAnniv">çºªå¿µæ—¥</button>
    <button onclick="loadTimelines('travel')" class="filter-btn" id="filterTimelineTravel">æ—…è¡Œ</button>
  </div>

  <div class="timeline-list" id="timelineList"></div>
</div>  <div class="menu page-transition hidden" id="galleryContent">
  <div class="lovebook-card">
    <div class="card-title"><span>ğŸ–¼ï¸ æ·»åŠ æ–°å›¾ç‰‡</span></div>
    <input type="file" id="galleryUploadInput" accept="image/*" multiple onchange="handleGalleryUpload()">
    <input type="text" id="galleryLinkInput" placeholder="æˆ–è¾“å…¥å›¾ç‰‡é“¾æ¥" onkeydown="if(event.key==='Enter'){addGalleryLink();}">
    <input type="text" id="galleryDescInput" placeholder="æè¿°/æ ‡ç­¾ï¼ˆå¦‚#æƒ…ä¾£ #è‡ªæ‹ #æ—…è¡Œï¼‰" maxlength="48" oninput="updateGalleryCharCount()">
    <span class="char-count" id="galleryDescCount"></span>
    <div class="card-buttons">
      <div class="button-row">
        <button onclick="saveGalleryImage()" class="qq-btn primary">ğŸ’¾ ä¿å­˜å›¾ç‰‡</button>
        <button onclick="clearGalleryInput()" class="qq-btn secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button onclick="showBatchGalleryPanel()" class="qq-btn secondary">ğŸ”— æ‰¹é‡ç®¡ç†</button>
      </div>
    </div>
  </div>

  <div class="gallery-tabs" id="galleryTabs">
    </div>

  <div class="gallery-list" id="galleryList"></div>
</div>  <div class="menu page-transition hidden" id="updateContent">
  <div class="lovebook-card">
    <div class="card-title"><span>ğŸ“˜ æ–°å»º/ç¼–è¾‘æ›´æ–°æ—¥è®°</span></div>
    <input type="date" id="updateDateInput">
    <input type="text" id="updateTagInput" placeholder="æ ‡ç­¾ï¼ˆå¦‚#ä¼˜åŒ– #ä½“éªŒï¼‰" maxlength="18" oninput="updateUpdateCharCount()">
    <span class="char-count" id="updateTagCount"></span>
    <textarea id="updateText" class="card-textarea" placeholder="è¿™æ¬¡æ›´æ–°äº†ä»€ä¹ˆï¼Ÿ" maxlength="160" oninput="updateUpdateCharCount();highlightUpdateTags();"></textarea>
    <span class="char-count" id="updateTextCount"></span>
    <div class="card-buttons">
      <div class="button-row">
        <button onclick="saveUpdateLog()" class="qq-btn primary">ğŸ’¾ ä¿å­˜æ—¥è®°</button>
        <button onclick="clearUpdateInput()" class="qq-btn secondary">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button onclick="showBatchUpdatePanel()" class="qq-btn secondary">ğŸ”— æ‰¹é‡ç®¡ç†</button>
      </div>
    </div>
  </div>

  <div class="filter-bar">
    <button onclick="loadUpdates('all')" class="filter-btn active" id="filterUpdateAll">å…¨éƒ¨</button>
    <button onclick="loadUpdates('fav')" class="filter-btn" id="filterUpdateFav">æœ€çˆ±</button>
    <button onclick="loadUpdates('major')" class="filter-btn" id="filterUpdateMajor">é‡å¤§</button>
    <button onclick="loadUpdates('opt')" class="filter-btn" id="filterUpdateOpt">ä¼˜åŒ–</button>
  </div>

  <div class="update-list" id="updateList"></div>
</div>  <div class="menu page-transition hidden" id="trashContent">
  <div class="trash-tabs" id="trashTabs">
    <button onclick="switchTrashTab('diary')" class="filter-btn active" id="trashTabDiary">ä¿¡ä»¶</button>
    <button onclick="switchTrashTab('dirty')" class="filter-btn" id="trashTabDirty">éªšè¯</button>
    <button onclick="switchTrashTab('lewd')" class="filter-btn" id="trashTabLewd">æ¹¿å¤œ</button>
    <button onclick="switchTrashTab('timeline')" class="filter-btn" id="trashTabTimeline">æ—¶é—´è½´</button>
    <button onclick="switchTrashTab('gallery')" class="filter-btn" id="trashTabGallery">å›¾ç‰‡</button>
    <button onclick="switchTrashTab('update')" class="filter-btn" id="trashTabUpdate">æ—¥è®°</button>
    
    <button onclick="clearCurrentTrash()" class="qq-btn secondary" style="margin-left:auto;">
      ğŸ—‘ï¸ æ¸…ç©ºå½“å‰
    </button>
  </div>

  <div class="trash-category-list" id="trashCategoryList"></div>

  <div class="trash-batch-actions" id="trashBatchActions" style="display:none;">
    <button onclick="toggleSelectAll()" class="qq-btn secondary">å…¨é€‰/åé€‰</button>
    
    <button onclick="batchRestoreTrash()" class="qq-btn primary">æ‰¹é‡æ¢å¤</button>
    <button onclick="batchDeleteTrash()" class="qq-btn secondary">æ‰¹é‡å½»åº•åˆ é™¤</button>
    <span class="trash-batch-count" id="trashBatchCount"></span>
  </div>
</div>  <div class="menu page-transition hidden" id="eggContent">
  <div class="egg-tabs" id="eggTabs">
    </div>

  <div class="egg-panel" id="eggPanel">
    </div>

  <div style="text-align:center;margin:20px 0;">
    <button class="qq-btn primary" onclick="addEggPage()">â• æ–°å¢å½©è›‹é¡µ</button>
    <button class="qq-btn secondary" onclick="importEggs()">ğŸ“‚ å¯¼å…¥</button>
    <button class="qq-btn secondary" onclick="exportEggs()">ğŸ’¾ å¯¼å‡º</button>
  </div>
</div>  <div class="panel-mask" id="panelMask" onclick="closeAnyPanel()"></div>

<div class="floating-panel hidden" id="randomLetterPanel" data-panel="random-letter">
  <button class="close-btn" onclick="closeRandomLetterPanel()">&times;</button>
  <div class="panel-content" id="randomLetterContent"><p class="fallback-text">åŠ è½½ä¸­â€¦</p></div>
</div>

<div class="floating-panel hidden" id="favoriteRankPanel" data-panel="favorite-rank">
  <button class="close-btn" onclick="closeFavoriteRankPanel()">&times;</button>
  <div class="favorite-tabs" id="favoriteTabs">
    <button onclick="switchFavoriteTab('diary')" class="filter-btn active" id="favTabDiary">ä¿¡ä»¶</button>
    <button onclick="switchFavoriteTab('dirty')" class="filter-btn" id="favTabDirty">éªšè¯</button>
    <button onclick="switchFavoriteTab('lewd')" class="filter-btn" id="favTabLewd">æ¹¿å¤œ</button>
    <button onclick="switchFavoriteTab('timeline')" class="filter-btn" id="favTabTimeline">æ—¶é—´è½´</button>
    <button onclick="switchFavoriteTab('gallery')" class="filter-btn" id="favTabGallery">å›¾ç‰‡</button>
    <button onclick="switchFavoriteTab('update')" class="filter-btn" id="favTabUpdate">æ—¥è®°</button>
  </div>
  <div class="panel-content" id="favoriteRankContent"><p class="fallback-text">åŠ è½½ä¸­â€¦</p></div>
</div>
<div class="global-search-bar" id="globalSearchBar">
  <button onclick="toggleSearchBar()" class="search-btn" title="å…¨å±€æœç´¢ (Ctrl+K)">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M20 20L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
  </button>
  <input type="text" id="globalSearchInput" placeholder="å…¨ç«™æœç´¢..." oninput="doGlobalSearch(this.value)" autocomplete="off">
  <button class="search-clear-btn" id="searchClearBtn" style="display:none;" onclick="clearGlobalSearch()" aria-label="æ¸…ç©º" title="æ¸…ç©º">&times;</button>
  <div class="search-result-panel" id="searchResultPanel"></div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
<script>
// js/lovebook.js
// =====================
// Lovebook ç»ˆæå…¨èåˆ - å…¨å±€å‘åŠ¨æœº (v11.0 - æœ€ç»ˆç‰ˆ - å«ç™»å½•/ä¸»é¢˜/åŠ¨ç”»)
// =====================
(function() {
    'use strict';

    // â€¼ï¸â€¼ï¸ è­¦å‘Šï¼šè¯·åœ¨è¿™é‡Œå¡«å…¥ä½ è‡ªå·±çš„ Firebase é…ç½®ï¼
    // â€¼ï¸â€¼ï¸ ä¸è¦ä½¿ç”¨æˆ‘è¿™é‡Œ AIzaSy... çš„å ä½ç¬¦ï¼
    const firebaseConfig = {
        apiKey: "AIzaSy...[è¯·æ›¿æ¢æˆä½ çš„KEY]...K1Wk",
        authDomain: "alice-ming-universe.firebaseapp.com",
        projectId: "alice-ming-universe",
        storageBucket: "alice-ming-universe.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:abcdef123456789abc"
    };

    // ================================================
    // ğŸ¦ å…¨å±€çŠ¶æ€ (v11.0 æ–°å¢)
    // ================================================
    let appState = {
        mainUnlocked: false,
        secondUnlocked: false,
        restrictedTag: '#restricted' // ä½ çš„â€œé™åˆ¶çº§â€æ ‡ç­¾
    };
    
    // (v11.0 æ–°å¢) ä¸»é¢˜åˆ—è¡¨
    const THEMES = [
        'theme-blue', 'theme-pink', 'theme-summer', 'theme-purple', 
        'theme-valentine', 'theme-christmas', 'theme-newyear', 
        'theme-birthday', 'theme-anniversary', 'theme-dark'
    ];

    // ================================================
    // ğŸ”§ æ ¸å¿ƒå·¥å…·åº“ (Utils) (v11.0 æœ€ç»ˆç‰ˆ)
    // ================================================
    const Utils = {
        showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`; 
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('visible'), 10);
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 500); 
            }, 2500);
        },
        getLocal(key) { return JSON.parse(localStorage.getItem(key) || '[]'); },
        setLocal(key, data) { localStorage.setItem(key, JSON.stringify(data)); },
        
        // (é‡‡çº³ Update ä¼˜åŒ– â‘ )
        emojiMap: {
            "ğŸ’‹":"äº²å»", "ğŸ’­":"æ€å¿µ", "â­":"åŠ æ˜Ÿ", "ğŸ˜ˆ":"å°æ¶é­”", "ğŸ±":"å°çŒ«å’ª",
            "ğŸ’¦":"æ¹¿æ¶¦", "ğŸ”¥":"ç‚½çƒ­", "ğŸŒ™":"å¤œæ™š", "ğŸ‚":"ç”Ÿæ—¥", "ğŸ‰":"çºªå¿µæ—¥",
            "âœˆï¸":"æ—…è¡Œ", "ğŸ’":"é¢†è¯", "ğŸ› ï¸":"ä¿®å¤", "âœ¨":"å‡çº§", "ğŸ’¡":"æ–°åŠŸèƒ½"
        },
        // (é‡‡çº³ Update ä¼˜åŒ– â‘ )
        highlightKeywords: {
            common: ['æ’’å¨‡','é¢†è¯','å»','ç¬¬ä¸€æ¬¡','å“„','äº²','è¡¨ç™½'],
            lewd: ['æ¹¿','ç‚½çƒ­','å‘»åŸ','å¤œ','å…¥'],
            timeline: ['çºªå¿µæ—¥','æ—…è¡Œ','å‘Šç™½','æƒŠå–œ','ç”Ÿæ—¥'],
            update: ['ä¼˜åŒ–','é‡å¤§','ä¿®å¤','åŠŸèƒ½','å½©è›‹','ä½“éªŒ','å‡çº§','ä¸Šçº¿']
        },
        renderContent(txt, customKeywords = []) {
            if (!txt) return ''; 
            const keywords = [...Utils.highlightKeywords.common, ...customKeywords]; 
            const keywordRegex = new RegExp(`(${keywords.join('|')})`, 'g'); 
            return txt .replace(/([\uD800-\uDBFF][\uDC00-\uDFFF])/g, (emoji) => { const name = Utils.emojiMap[emoji] || 'emoji'; return `<span class="emoji-hl" title="${name}">${emoji}</span>`; }) .replace(keywordRegex, '<span class="hl">$1</span>'); 
        },
        
        saveToFirebase: async function(collection, data) { 
            if (!window.db) return false; 
            try { const docRef = await window.addDoc(window.collection(window.db, collection), data); return docRef.id; } 
            catch (err) { console.error(`Firebaseä¿å­˜å¤±è´¥ (${collection}):`, err); return false; } 
        },
        updateFirebase: async function(collection, id, data) { 
            if (!window.db) return false; 
            try { await window.updateDoc(window.doc(window.db, collection, id), data); return true; } 
            catch (err) { console.error(`Firebaseæ›´æ–°å¤±è´¥ (${collection}/${id}):`, err); return false; } 
        },
        
        toggleStar: async function(collection, id, localGetter, localSetter) { 
            let items = localGetter(); 
            const item = items.find(i => i.id === id); 
            if (!item) return; 
            const newStar = !item.star; 
            items = items.map(i => i.id === id ? { ...i, star: newStar } : i); 
            localSetter(items); 
            await Utils.updateFirebase(collection, id, { star: newStar }); 
            return newStar; 
        },
        softDelete: async function(collection, id, localGetter, localSetter) { 
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿï¼ˆå¯åœ¨å›æ”¶ç«™æ¢å¤ï¼‰')) return false; 
            let items = localGetter(); 
            items = items.filter(i => i.id !== id); 
            localSetter(items); 
            await Utils.updateFirebase(collection, id, { isDeleted: true, deletedAt: Date.now() }); 
            Utils.showToast('å·²ç§»å…¥å›æ”¶ç«™', 'success'); 
            return true; 
        },
        copyItem: function(localGetter, id) { 
            const item = localGetter().find(i => i.id === id); 
            if (!item) return; 
            navigator.clipboard.writeText(item.text || item.url || ''); 
            Utils.showToast('ğŸ“‹ å·²å¤åˆ¶'); 
        },
        
        formatDate: function(dateInput) { 
            if (!dateInput) return ''; 
            if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) return dateInput; 
            try { const date = new Date(dateInput); return new Intl.DateTimeFormat('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(date).replace(/\//g, '-'); } 
            catch { return ''; } 
        },
        getRelativeTime: function(dateInput) { 
            if (!dateInput) return ''; 
            try { 
                const date = new Date(dateInput); 
                const now = new Date(); 
                const diffMs = now - date; 
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) return 'æœªæ¥'; 
                if (diffDays === 0) return 'ä»Šå¤©'; 
                if (diffDays === 1) return 'æ˜¨å¤©'; 
                if (diffDays < 7) return `${diffDays}å¤©å‰`; 
                if (diffDays < 30) return `${Math.floor(diffDays / 7)}å‘¨å‰`; 
                if (diffDays < 365) return `${Math.floor(diffDays / 30)}ä¸ªæœˆå‰`; 
                return `${Math.floor(diffDays / 365)}å¹´å‰`; 
            } catch { return ''; } 
        },
        getDaysUntil: function(dateStr) { 
            if (!dateStr) return null; 
            try { 
                const target = new Date(dateStr); 
                const now = new Date(); 
                now.setHours(0, 0, 0, 0); 
                target.setHours(0, 0, 0, 0); 
                const diffMs = target - now; 
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) return null; 
                if (diffDays === 0) return 'å°±æ˜¯ä»Šå¤©ï¼'; 
                return `è¿˜æœ‰ ${diffDays} å¤©`; 
            } catch { return null; } 
        },
        
        uploadImageToStorage: async function(file) { 
            if (!window.storage || !window.uploadBytes) { console.warn('Firebase Storage æœªåˆå§‹åŒ–æˆ– uploadBytes æœªåŠ è½½'); return URL.createObjectURL(file); } 
            try { 
                const timestamp = Date.now(); 
                const fileName = `gallery/${timestamp}_${file.name}`; 
                const storageRef = window.ref(window.storage, fileName); 
                const snapshot = await window.uploadBytes(storageRef, file); 
                const downloadURL = await window.getDownloadURL(snapshot.ref); 
                return downloadURL; 
            } catch (err) { console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', err); Utils.showToast('âš ï¸ äº‘ç«¯ä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é¢„è§ˆ', 'error'); return URL.createObjectURL(file); } 
        },
        renderLazyImage: function(url, alt = '') { 
            const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect fill='%23f0f0f0' width='400' height='300'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='%23999' font-size='20'%3EåŠ è½½ä¸­...%3C/text%E%3C/svg%3E"; 
            return ` <img data-src="${url}" alt="${alt}" class="lazy-img" style="max-width:100%;border-radius:12px;background:#f0f0f0;" src="${placeholderSvg}" /> `; 
        },
        initLazyLoad: function() { 
            const observer = new IntersectionObserver((entries) => { 
                entries.forEach(entry => { 
                    if (entry.isIntersecting) { 
                        const img = entry.target; 
                        img.src = img.dataset.src; 
                        img.classList.add('loaded'); 
                        observer.unobserve(img); 
                    } 
                }); 
            }, { rootMargin: '50px' }); 
            document.querySelectorAll('.lazy-img').forEach(img => { observer.observe(img); }); 
        },
        showImageLightbox: function(url, desc) { 
            const safeDesc = (desc||'').replace(/"/g, '&quot;'); 
            const lightbox = document.createElement('div'); 
            lightbox.className = 'image-lightbox'; 
            lightbox.innerHTML = ` <div class="lightbox-overlay" onclick="closeAnyPanel()"></div> <div class="lightbox-content"> <img src="${url}" alt="${safeDesc}" style="max-width:90vw;max-height:90vh;border-radius:12px;"> <p style="color:#fff;margin-top:12px;text-align:center;">${safeDesc}</p> <button class="close-btn" onclick="closeAnyPanel()" aria-label="å…³é—­">&times;</button> </div> `; 
            document.body.appendChild(lightbox); 
        },
        
        generateVersionNumber: function(updatesList) { 
            const currentCount = updatesList.length; 
            const major = Math.floor(currentCount / 10); 
            const minor = currentCount % 10; 
            return `v${major}.${minor}`; 
        },
        
        autoCleanExpiredTrash: function() { 
            if (!window.TRASH_MODULES) return; 
            const expireDays = 30; 
            const expireTime = Date.now() - (expireDays * 24 * 60 * 60 * 1000); 
            console.log("æ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ¸…ç†..."); 
            window.TRASH_MODULES.forEach(mod => { 
                let list = mod.get(); 
                const before = list.length; 
                list = list.filter(item => { return !item.isDeleted || (item.deletedAt || 0) > expireTime; }); 
                if (list.length < before) { mod.set(list); console.log(`å·²è‡ªåŠ¨æ¸…ç† ${mod.label} ä¸­ ${before - list.length} æ¡è¿‡æœŸæ•°æ®`); } 
            }); 
        },
        getTrashStats: function() { 
            if (!window.TRASH_MODULES) return { total: 0 }; 
            let total = 0; 
            const stats = {}; 
            window.TRASH_MODULES.forEach(mod => { 
                const count = (mod.get() || []).filter(d => d.isDeleted).length; 
                stats[mod.key] = count; 
                total += count; 
            }); 
            return { total, ...stats }; 
        },
        
        loadMarked: function() { 
            if (window.marked) return Promise.resolve(); 
            return new Promise((resolve, reject) => { 
                const script = document.createElement('script'); 
                script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'; 
                script.onload = resolve; 
                script.onerror = reject; 
                document.head.appendChild(script); 
            }); 
        },
        escapeHtml: function(str) { 
            return (str || '').replace(/[<>&"]/g, c => ({ "<": "&lt;", ">": "&gt;", "&": "&amp;", "\"": "&quot;" }[c])); 
        },
        initEggTabDrag: function() { 
            const container = document.getElementById('eggTabs'); 
            let draggedItem = null; 
            let draggedIndex = null; 
            container.querySelectorAll('.egg-tab-wrapper[draggable="true"]').forEach((tab, index) => { 
                tab.addEventListener('dragstart', (e) => { 
                    draggedItem = tab; 
                    draggedIndex = index; 
                    e.dataTransfer.effectAllowed = 'move'; 
                    tab.classList.add('dragging'); 
                }); 
                tab.addEventListener('dragend', () => { tab.classList.remove('dragging'); }); 
                tab.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }); 
                tab.addEventListener('drop', (e) => { 
                    e.preventDefault(); 
                    if (!draggedItem || draggedIndex === null) return; 
                    const targetIndex = Array.from(container.children).indexOf(tab); 
                    if (draggedIndex === targetIndex) return; 
                    let eggs = getLocalEggs(); 
                    const [draggedEgg] = eggs.splice(draggedIndex, 1); 
                    eggs.splice(targetIndex, 0, draggedEgg); 
                    setLocalEggs(eggs); 
                    loadEggTabs(); 
                    Utils.showToast('âœ… æ’åºå·²æ›´æ–°'); 
                }); 
            }); 
        },
        
        capitalize: function(str){ if (!str) return ''; return str[0].toUpperCase() + str.slice(1); },
        tagColors: ['var(--accent)', '#ff69b4', '#8b5cf6', '#ff9933', '#5cbf60', '#fbae3c', '#ea638c'],
        
        smartSearch: function(items, keyword) { 
            if (!keyword) return []; 
            const kw = keyword.toLowerCase(); 
            return items.map(item => { 
                let score = 0; 
                const text = (item.text || item.desc || '').toLowerCase(); 
                const tags = (item.tags || []).join(' ').toLowerCase(); 
                if (tags.includes(kw)) score += 8; 
                if (text.includes(kw)) score += 5; 
                if (tags.split(' ').some(tag => tag.includes(kw))) score += 3; 
                if (text === kw) score += 10; 
                if (text.startsWith(kw)) score += 3; 
                return { ...item, _score: score }; 
            }).filter(item => item._score > 0).sort((a, b) => b._score - a._score); 
        },
        SEARCH_HISTORY_KEY: 'searchHistory', 
        MAX_HISTORY: 10,
        getSearchHistory: function() { 
            return JSON.parse(localStorage.getItem(Utils.SEARCH_HISTORY_KEY) || '[]'); 
        },
        addSearchHistory: function(keyword) { 
            if (!keyword) return; 
            let history = Utils.getSearchHistory(); 
            history = history.filter(item => item !== keyword); 
            history.unshift(keyword); 
            history = history.slice(0, Utils.MAX_HISTORY); 
            localStorage.setItem(Utils.SEARCH_HISTORY_KEY, JSON.stringify(history)); 
        },
        clearSearchHistory: function() { 
            localStorage.removeItem(Utils.SEARCH_HISTORY_KEY); 
            showSearchHistory(); 
        },

        // --- â­ï¸ v11.0 æ–°å¢ï¼š(æ‰“å­—æœº) ---
        typewriter: function(element, text, speed = 75, onComplete = null) {
            let i = 0;
            element.innerHTML = ''; // æ¸…ç©º
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else if (onComplete) {
                    onComplete();
                }
            }
            type();
        },
        
        // --- â­ï¸ v11.0 æ–°å¢ï¼š(ä¸»é¢˜æ§åˆ¶) ---
        setTheme: function(themeName) {
            if (!THEMES.includes(themeName)) themeName = 'theme-blue';
            document.body.className = themeName;
            localStorage.setItem('lovebook-theme', themeName);
            // å¦‚æœä¸æ˜¯æš—è‰²ï¼Œå°±ä¿å­˜ä¸ºâ€œä¸Šä¸€ä¸ªäº®è‰²ä¸»é¢˜â€
            if (themeName !== 'theme-dark') {
                localStorage.setItem('lovebook-theme-light', themeName);
            }
        },
        toggleNightMode: function() {
            if (document.body.className.includes('theme-dark')) {
                const lastTheme = localStorage.getItem('lovebook-theme-light') || 'theme-blue';
                Utils.setTheme(lastTheme);
            } else {
                Utils.setTheme('theme-dark');
            }
        },
        setRandomTheme: function() {
            const lightThemes = THEMES.filter(t => t !== 'theme-dark');
            const randomTheme = lightThemes[Math.floor(Math.random() * lightThemes.length)];
            Utils.setTheme(randomTheme);
        }
    };
    window.Utils = Utils;

    // ================================================
    // âŒ¨ï¸ å…¨å±€é”®ç›˜/ç‚¹å‡»äº‹ä»¶ç›‘å¬ (v11.0)
    // ================================================
    (function initGlobalListeners() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAnyPanel();
                toggleSearchBar(true); // (é‡‡çº³ Search) ä¹Ÿå…³é—­æœç´¢
            }
            
            const isRandomPanelOpen = document.getElementById('randomLetterPanel')?.classList.contains('show');
            if (e.key === ' ' && isRandomPanelOpen && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                showRandomLetter();
            }

            if (e.ctrlKey && (e.key === 'k' || e.key === 'K')) {
                e.preventDefault();
                toggleSearchBar();
            }
        });

        document.addEventListener('click', e => {
            const searchBar = document.getElementById('globalSearchBar');
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æœç´¢æ¡ (åŠå…¶å­å…ƒç´ )ï¼Œåˆ™å…³é—­
            if (searchBar && !searchBar.contains(e.target)) {
                toggleSearchBar(true);
            }
        });
    })();// ================================================
    // ğŸ”¥ Firebase åˆå§‹åŒ– (v11.0 æœ€ç»ˆç‰ˆ)
    // ================================================
    (function initFirebase(){
        if(typeof firebase==="undefined"){
            console.error("Firebase SDK æœªèƒ½æ­£ç¡®åŠ è½½ï¼");
            Utils.showToast("âŒ æ ¸å¿ƒæœåŠ¡åŠ è½½å¤±è´¥", "error");
            return;
        }
        if(window.firebaseApp) return;
        
        console.log("æ­£åœ¨åˆå§‹åŒ– Firebase...");
        const{initializeApp}=firebase.app;
        const{getFirestore,collection,doc,addDoc,updateDoc,getDocs,query,where}=firebase.firestore;
        const{getStorage,ref,getDownloadURL,uploadBytes}=firebase.storage;
        
        try {
            window.firebaseApp=initializeApp(firebaseConfig);
            window.db=getFirestore(window.firebaseApp);
            window.collection=collection;
            window.doc=doc;
            window.addDoc=addDoc;
            window.updateDoc=updateDoc;
            window.getDocs=getDocs;
            window.query=query;
            window.where=where;
            window.storage=getStorage(window.firebaseApp);
            window.ref=ref;
            window.getDownloadURL=getDownloadURL;
            window.uploadBytes=uploadBytes;
            console.log("Firebase v9 æ¨¡å—åŒ– (å…¨å±€) åˆå§‹åŒ–æˆåŠŸï¼");
        } catch (err) {
            console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", err);
            Utils.showToast(`âŒ åˆå§‹åŒ–å¤±è´¥: ${err.message}`, "error");
        }
    })();

    // ================================================
    // ğŸš€ æ ¸å¿ƒè·¯ç”± & ç™»å½• (v11.0 æœ€ç»ˆç‰ˆ)
    // ================================================
    
    // (é‡‡çº³ v11.0 ä¼˜åŒ–)
    window.verifyMainPassword = function() {
        const pass = document.getElementById('mainPassword').value;
        const errorEl = document.getElementById('mainError');
        
        // ä½ çš„ä¸»å¯†ç 
        if (pass === 'Alicecat') {
            appState.mainUnlocked = true;
            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('menuPage').classList.remove('hidden');
            Utils.showToast('æ¬¢è¿å›æ¥ï¼ŒAlice Mingï¼ğŸ’–');
            errorEl.style.display = 'none';
        } else {
            errorEl.style.display = 'block';
            // æŠ–åŠ¨åŠ¨ç”»
            const loginBox = document.getElementById('loginBox');
            loginBox.classList.add('shake');
            setTimeout(() => loginBox.classList.remove('shake'), 500);
        }
    };
    
    // (é‡‡çº³ v11.0 ä¼˜åŒ–)
    window.verifySecondPassword = function() {
        const pass = document.getElementById('secondPassword').value;
        const errorEl = document.getElementById('secondError');
        const lockedBox = document.getElementById('lockedBox');
        const targetRoute = lockedBox.dataset.targetRoute;
        
        // ä½ çš„äºŒçº§å¯†ç 
        if (pass === 'AM250530') {
            appState.secondUnlocked = true;
            lockedBox.classList.add('hidden');
            Utils.showToast('ğŸ” äºŒçº§å¯†ç å·²è§£é”');
            errorEl.style.display = 'none';
            document.getElementById('secondPassword').value = ''; // æ¸…ç©ºå¯†ç 
            
            // è·¯ç”±åˆ°ç›®æ ‡
            if (targetRoute) {
                routeTo(targetRoute, true); // true = ç»•è¿‡æ£€æŸ¥
            }
        } else {
            errorEl.style.display = 'block';
            lockedBox.classList.add('shake');
            setTimeout(() => lockedBox.classList.remove('shake'), 500);
        }
    };

    // (é‡‡çº³ v11.0 ä¼˜åŒ–) è·¯ç”±å®ˆå«
    window.routeTo = function(pageId, bypassCheck = false) {
        console.log("è·¯ç”±åˆ°:", pageId);
        toggleSearchBar(true); // è·¯ç”±æ—¶å…³é—­æœç´¢
        
        // â€¼ï¸ æ ¸å¿ƒï¼šäºŒçº§å¯†ç ä¿æŠ¤
        // (æ—¥è®°, éªšè¯, æ¹¿å¤œ, å½©è›‹é¡µ, å›¾ç‰‡åŒº)
        const protectedRoutes = ['diaryContent', 'dirtyContent', 'lewdContent', 'eggContent', 'galleryContent'];
        
        if (protectedRoutes.includes(pageId) && !appState.secondUnlocked && !bypassCheck) {
            console.log("è·¯ç”±è¢«æ‹¦æˆªï¼Œéœ€è¦äºŒçº§å¯†ç :", pageId);
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page-transition').forEach(page => page.classList.add('hidden'));
            
            // æ˜¾ç¤º lockedBox
            const lockedBox = document.getElementById('lockedBox');
            lockedBox.classList.remove('hidden');
            lockedBox.dataset.targetRoute = pageId; // å­˜å‚¨ç›®æ ‡
            
            // è®¾ç½®æ ‡é¢˜
            const titles = {
                'diaryContent': 'æ•è¾¹ä¿¡ç¬º', 'dirtyContent': 'å¿ƒè·³è¯å…¸', 
                'lewdContent': 'è¢«ä½ å†™æ¹¿çš„ç¬¬Nå¤œ', 'eggContent': 'å½©è›‹åŒº', 
                'galleryContent': 'å›¾ç‰‡æ”¶è—åŒº'
            };
            document.getElementById('lockedTitle').innerText = `è¯·è¾“å…¥äºŒçº§å¯†ç è§£é” ${titles[pageId] || ''}`;
            document.getElementById('secondPassword').focus();
            
            return; // åœæ­¢è·¯ç”±
        }
        // â€¼ï¸ ä¿æŠ¤ç»“æŸ
        
        document.querySelectorAll('.page-transition').forEach(page => page.classList.add('hidden'));
        
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
            
            // æŒ‰éœ€åŠ è½½æ•°æ®
            switch (pageId) {
                case 'diaryContent':
                    if (typeof window.loadDiaries === 'function') window.loadDiaries('all');
                    break;
                case 'dirtyContent':
                    if (typeof window.loadDirties === 'function') window.loadDirties('all');
                    break;
                case 'lewdContent':
                    if (typeof window.loadLewds === 'function') window.loadLewds('all');
                    break;
                case 'timelineContent':
                    if (typeof window.loadTimelines === 'function') window.loadTimelines('all');
                    break;
                case 'galleryContent':
                    if (typeof window.loadGallery === 'function') {
                        // â€¼ï¸ v11.0 æ ¸å¿ƒï¼šä¼ é€’è§£é”çŠ¶æ€
                        window.loadGallery(); 
                    }
                    break;
                case 'updateContent':
                    if (typeof window.loadUpdates === 'function') window.loadUpdates('all');
                    break;
                case 'trashContent':
                    if (typeof window.switchTrashTab === 'function') {
                        Utils.autoCleanExpiredTrash();
                        window.switchTrashTab('diary');
                    }
                    break;
                case 'eggContent':
                    if (typeof window.loadEggTabs === 'function') window.loadEggTabs();
                    break;
            }
        } else {
            console.error("æœªæ‰¾åˆ°é¡µé¢:", pageId);
        }
    };
    
    // ================================================
    // ğŸ“ æ¨¡å—æ•°æ®è®¿é—®å™¨ (v11.0 æœ€ç»ˆç‰ˆ)
    // ================================================
    window.getLocalDiaries = () => Utils.getLocal('diaryList');
    window.setLocalDiaries = (data) => Utils.setLocal('diaryList', data);
    window.getLocalDirties = () => Utils.getLocal('dirtyList');
    window.setLocalDirties = (data) => Utils.setLocal('dirtyList', data);
    window.getLocalLewds = () => Utils.getLocal('lewdList');
    window.setLocalLewds = (data) => Utils.setLocal('lewdList', data);
    window.getLocalTimelines = () => Utils.getLocal('timelineList');
    window.setLocalTimelines = (data) => Utils.setLocal('timelineList', data);
    window.getLocalGallery = () => Utils.getLocal('galleryList');
    window.setLocalGallery = (data) => Utils.setLocal('galleryList', data);
    window.getLocalUpdates = () => Utils.getLocal('updateList');
    window.setLocalUpdates = (data) => Utils.setLocal('updateList', data);
    window.getLocalEggs = () => Utils.getLocal('eggList');
    window.setLocalEggs = (data) => Utils.setLocal('eggList', data);

    // ================================================
    // ================================================
    // ========== â¬‡ï¸ æ¨¡å—JSç²˜è´´åŒº â¬‡ï¸ ==========
    // ================================================
    // ================================================

    // (è¾…åŠ©å‡½æ•°)
    function renderTagColored(tag, idx) { return `<span class="tag" style="background:${Utils.tagColors[idx % Utils.tagColors.length]};color:#fff;border-radius:7px;padding:0 7px;margin-right:4px;">${tag}</span>`; }
    function escapeGalleryDesc(str) { return (str||'').replace(/[<>&\"]/g, c=>({"<":"&lt;",">":"&gt;","&":"&amp;","\"":"&quot;"}[c])); }
    // (Diary æ¨¡å—çš„å ä½ç¬¦ï¼Œv1.0 JS é‡Œä½ å¯èƒ½æ¼äº†)
    window.parseTagInput = function() {};
    window.autoFormatDiary = function() {};
    window.addToTimeline = function() { Utils.showToast('åŠŸèƒ½å¼€å‘ä¸­...', 'warning'); };
    window.importDiaries = function() { Utils.showToast('åŠŸèƒ½å¼€å‘ä¸­...', 'warning'); };
    window.exportDiaries = function() { Utils.showToast('åŠŸèƒ½å¼€å‘ä¸­...', 'warning'); };


    // ===================== 1ï¸âƒ£ Diary ä¿¡ä»¶åŒº =====================
    // AI é¢„è§ˆ
    const aiLetterPool = [
      "æ™šå®‰ï¼Œä»Šå¤©ä¹Ÿè¶…çº§å–œæ¬¢ä½ ã€‚", "æƒ³ä½ æƒ³å¾—éƒ½è¦å†’æ³¡äº†ğŸ’­",
      "ä½ åœ¨çš„æ—¶å€™é£éƒ½å¾ˆæ¸©æŸ”ã€‚", "çœ‹åˆ°ä½ çš„æ¶ˆæ¯ä¼šå¿ƒè·³åŠ é€Ÿï¼",
      "å·å·å†™ä¸‹ä¸€ç™¾éå–œæ¬¢ä½ ã€‚", "æœ‰ä½ çš„ä¸€å¤©æ¯åˆ†æ¯ç§’éƒ½ç”œåˆ°ä¸è¡Œã€‚"
    ];
    window.showAIPreview = function(keyword) {
      let filtered = keyword ? aiLetterPool.filter(t => t.includes(keyword)) : aiLetterPool;
      let rand = filtered.length ? filtered[Math.floor(Math.random() * filtered.length)] : aiLetterPool[0];
      document.getElementById('aiPreviewArea').innerText = rand;
    };
    
    window.loadDiaries=async function(filter="all"){
        let diaries=Utils.getLocal("diaryList");
        try{
            const q=window.query(window.collection(window.db,"diaries"),window.where("isDeleted","==",false));
            const snap=await window.getDocs(q);
            diaries=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
            Utils.setLocal("diaryList",diaries)
        }catch(err){console.warn("æ— æ³•ä»FirebaseåŠ è½½Diariesï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜",err)}
        let list=diaries;
        if(filter==="Alice")list=diaries.filter(d=>d.from==="Alice");
        else if(filter==="Ming")list=diaries.filter(d=>d.from==="Ming");
        else if(filter==="Private")list=diaries.filter(d=>d.from==="Private");
        list=list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        document.getElementById("diaryList").innerHTML=list.map(d=>`
            <div class="diary-card${d.star?" starred":""}${d.locked?" locked":""}" data-id="${d.id}">
                <div class="diary-tags">${(d.tags||[]).map((t,i)=>renderTagColored(t,i)).join("")}</div>
                <div class="diary-content">${Utils.renderContent(d.text)}</div>
                <div class="diary-meta">
                    <span class="diary-from">${d.from==="Alice"?"ğŸ’‹ Alice":"æˆ‘"}</span>
                    <span class="diary-date">${new Date(d.createdAt).toLocaleDateString()}</span>
                    ${d.locked?'<span class="lock-icon" title="é”å®šï¼Œä¸å¯åˆ ">ğŸ”’</span>':""}
                    <button onclick="starDiary('${d.id}')">${d.star?"â­":"â˜†"}</button>
                    ${!d.locked?`<button onclick="deleteDiary('${d.id}')">ğŸ—‘ï¸</button>`:""}
                    <button onclick="copyDiary('${d.id}')">ğŸ“‹</button>
                </div>
            </div>`).join("")
    };
    window.saveDiary=async function(from){
        const text=document.getElementById("diaryText").value.trim();
        if(!text)return Utils.showToast("ä¿¡ä»¶ä¸èƒ½ä¸ºç©º","error");
        const tags=document.getElementById("tagInput").value.split(/[#,ï¼Œ ]+/).filter(Boolean);
        const d={text,tags,from,star:false,locked:from==="Alice",createdAt:Date.now(),isDeleted:false};
        const diaries=Utils.getLocal("diaryList");
        diaries.push({...d,id:"local_"+Date.now()});
        Utils.setLocal("diaryList",diaries);
        const firebaseId=await Utils.saveToFirebase("diaries",d);
        loadDiaries();
        if(firebaseId)Utils.showToast("âœ… å·²ä¿å­˜åˆ°äº‘ç«¯");
        else Utils.showToast("âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆäº‘ç«¯åŒæ­¥å¤±è´¥ï¼‰","warning");
        clearDiaryInput()
    };
    window.clearDiaryInput=function(){
        document.getElementById("tagInput").value="";
        document.getElementById("diaryText").value="";
        updateDiaryCharCount()
    };
    window.starDiary=async function(id){
        await Utils.toggleStar("diaries",id,()=>Utils.getLocal("diaryList"),data=>Utils.setLocal("diaryList",data));
        loadDiaries()
    };
    window.deleteDiary=async function(id){
        const deleted=await Utils.softDelete("diaries",id,()=>Utils.getLocal("diaryList"),data=>Utils.setLocal("diaryList",data));
        if(deleted)loadDiaries()
    };
    window.copyDiary=function(id){
        Utils.copyItem(()=>Utils.getLocal("diaryList"),id)
    };
    document.getElementById("diaryText")?.addEventListener("paste",function(e){
        if(document.getElementById("diaryPlainPaste")?.checked){
            e.preventDefault();
            const text=(e.clipboardData||window.clipboardData).getData("text");
            document.execCommand("insertText",false,text)
        }
    });
    window.updateDiaryCharCount=function(){
        const tagEl = document.getElementById("tagInputCount");
        const textEl = document.getElementById("diaryTextCount");
        if (!tagEl || !textEl) return;
        
        const t=document.getElementById("tagInput").value.length;
        const c=document.getElementById("diaryText").value.length;
        tagEl.innerText=t+"/24";
        textEl.innerText=c+"/480"
    };

    // ===================== 2ï¸âƒ£ Dirty å¿ƒè·³è¯å…¸åŒº =====================
    window.loadDirties=async function(filter="all"){
        let dirties=Utils.getLocal("dirtyList");
        try{
            const q=window.query(window.collection(window.db,"dirties"),window.where("isDeleted","==",false));
            const snap=await window.getDocs(q);
            dirties=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
            Utils.setLocal("dirtyList",dirties)
        }catch(err){console.warn("æ— æ³•ä»FirebaseåŠ è½½Dirtiesï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜",err)}
        let list=dirties;
        if(filter==="fav")list=dirties.filter(d=>d.star);
        else if(filter==="group1")list=dirties.filter(d=>d.tags?.includes("äº²æ˜µ"));
        else if(filter==="group2")list=dirties.filter(d=>d.tags?.includes("å“„éª—"));
        list=list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        document.getElementById("dirtyList").innerHTML=list.map(d=>`
            <div class="dirty-card${d.star?" starred":""}" data-id="${d.id}">
                <div class="dirty-tags">${(d.tags||[]).map((t,i)=>renderTagColored(t,i)).join("")}</div>
                <div class="dirty-content">${Utils.renderContent(d.text)}</div>
                <div class="dirty-meta">
                    <button onclick="starDirty('${d.id}')">${d.star?"â­":"â˜†"}</button>
                    <button onclick="deleteDirty('${d.id}')">ğŸ—‘ï¸</button>
                    <button onclick="copyDirty('${d.id}')">ğŸ“‹</button>
                </div>
            </div>`).join("")
    };
    window.saveDirty=async function(){
        const title=document.getElementById("dirtyTitle").value.trim();
        const text=document.getElementById("dirtyText").value.trim();
        if(!title||!text)return Utils.showToast("âŒ å†…å®¹ä¸èƒ½ä¸ºç©º","error");
        const tags=title.split(/[#,ï¼Œ\s]+/).filter(Boolean);
        const d={text,tags,star:false,createdAt:Date.now(),isDeleted:false};
        const dirties=Utils.getLocal("dirtyList");
        dirties.push({...d,id:"local_"+Date.now()});
        Utils.setLocal("dirtyList",dirties);
        const firebaseId=await Utils.saveToFirebase("dirties",d);
        loadDirties();
        if(firebaseId)Utils.showToast("âœ… å·²ä¿å­˜åˆ°äº‘ç«¯");
        else Utils.showToast("âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆäº‘ç«¯åŒæ­¥å¤±è´¥ï¼‰","warning");
        clearDirtyInput()
    };
    window.clearDirtyInput=function(){
        document.getElementById("dirtyTitle").value="";
        document.getElementById("dirtyText").value="";
        updateDirtyCharCount()
    };
    window.starDirty=async function(id){
        await Utils.toggleStar("dirties",id,()=>Utils.getLocal("dirtyList"),data=>Utils.setLocal("dirtyList",data));
        loadDirties()
    };
    window.deleteDirty=async function(id){
        const deleted=await Utils.softDelete("dirties",id,()=>Utils.getLocal("dirtyList"),data=>Utils.setLocal("dirtyList",data));
        if(deleted)loadDirties()
    };
    window.copyDirty=function(id){
        Utils.copyItem(()=>Utils.getLocal("dirtyList"),id)
    };
    document.getElementById("dirtyText")?.addEventListener("paste",function(e){
        if(document.getElementById("dirtyPlainPaste")?.checked){
            e.preventDefault();
            const text=(e.clipboardData||window.clipboardData).getData("text");
            document.execCommand("insertText",false,text)
        }
    });
    window.updateDirtyCharCount=function(){
        const tagEl = document.getElementById("dirtyTitleCount");
        const textEl = document.getElementById("dirtyTextCount");
        if (!tagEl || !textEl) return;
        
        const t=document.getElementById("dirtyTitle").value.length;
        const c=document.getElementById("dirtyText").value.length;
        tagEl.innerText=t+"/16";
        textEl.innerText=c+"/120"
    };
    window.highlightDirtyTags = function() {};
    window.showBatchDirtyPanel=function(){Utils.showToast("ğŸ“¦ æ‰¹é‡ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...","warning")};

    // ===================== 3ï¸âƒ£ Lewd æ¹¿å¤œåŒº =====================
    window.loadLewds=async function(filter="all"){
        let lewds=Utils.getLocal("lewdList");
        try{
            const q=window.query(window.collection(window.db,"lewds"),window.where("isDeleted","==",false));
            const snap=await window.getDocs(q);
            lewds=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
            Utils.setLocal("lewdList",lewds)
        }catch(err){console.warn("æ— æ³•ä»FirebaseåŠ è½½Lewdsï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜",err)}
        let list=lewds;
        if(filter==="fav")list=lewds.filter(d=>d.star);
        else if(filter==="group1")list=lewds.filter(d=>d.tags?.includes("ç¾æ¶©"));
        else if(filter==="group2")list=lewds.filter(d=>d.tags?.includes("ç‚½çƒ­"));
        list=list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        document.getElementById("lewdList").innerHTML=list.map(d=>`
            <div class="lewd-card${d.star?" starred":""}" data-id="${d.id}">
                <div class="lewd-tags">${(d.tags||[]).map((t,i)=>renderTagColored(t,i)).join("")}</div>
                <div class="lewd-content">${Utils.renderContent(d.text,Utils.highlightKeywords.lewd)}</div>
                <div class="lewd-meta">
                    <button onclick="starLewd('${d.id}')">${d.star?"â­":"â˜†"}</button>
                    <button onclick="deleteLewd('${d.id}')">ğŸ—‘ï¸</button>
                    <button onclick="copyLewd('${d.id}')">ğŸ“‹</button>
                </div>
            </div>`).join("")
    };
    window.saveLewd=async function(){
        const tagRaw=document.getElementById("lewdTagInput").value.trim();
        const text=document.getElementById("lewdText").value.trim();
        if(!text)return Utils.showToast("âŒ å†…å®¹ä¸èƒ½ä¸ºç©º","error");
        const tags=tagRaw.split(/[#,ï¼Œ\s]+/).filter(Boolean);
        const d={text,tags,star:false,createdAt:Date.now(),isDeleted:false};
        const lewds=Utils.getLocal("lewdList");
        lewds.push({...d,id:"local_"+Date.now()});
        Utils.setLocal("lewdList",lewds);
        const firebaseId=await Utils.saveToFirebase("lewds",d);
        loadLewds();
        if(firebaseId)Utils.showToast("âœ… å·²ä¿å­˜åˆ°äº‘ç«¯");
        else Utils.showToast("âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆäº‘ç«¯åŒæ­¥å¤±è´¥ï¼‰","warning");
        clearLewdInput()
    };
    window.starLewd=async function(id){
        await Utils.toggleStar("lewds",id,()=>Utils.getLocal("lewdList"),data=>Utils.setLocal("lewdList",data));
        loadLewds()
    };
    window.deleteLewd=async function(id){
        const deleted=await Utils.softDelete("lewds",id,()=>Utils.getLocal("lewdList"),data=>Utils.setLocal("lewdList",data));
        if(deleted)loadLewds()
    };
    window.copyLewd=function(id){
        Utils.copyItem(()=>Utils.getLocal("lewdList"),id)
    };
    window.clearLewdInput=function(){
        document.getElementById("lewdTagInput").value="";
        document.getElementById("lewdText").value="";
        updateLewdCharCount()
    };
    window.showBatchLewdPanel=function(){Utils.showToast("ğŸ“¦ æ‰¹é‡ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...","warning")};
    window.highlightLewdTags=function(){
        const textarea=document.getElementById("lewdText");
        const text=textarea.value;
        const spicyWords=["æ¹¿","ç‚½çƒ­","å‘»åŸ","å…¥"];
        const hasSpicy=spicyWords.some(word=>text.includes(word));
        textarea.classList.toggle("spicy-border",hasSpicy)
    };
    document.getElementById("lewdText")?.addEventListener("paste",function(e){
        if(document.getElementById("lewdPlainPaste")?.checked){
            e.preventDefault();
            const text=(e.clipboardData||window.clipboardData).getData("text");
            document.execCommand("insertText",false,text)
        }
    });
    window.updateLewdCharCount=function(){
        const tagEl = document.getElementById("lewdTagCount");
        const textEl = document.getElementById("lewdTextCount");
        if (!tagEl || !textEl) return;
        
        const t=document.getElementById("lewdTagInput").value.length;
        const c=document.getElementById("lewdText").value.length;
        tagEl.innerText=t+"/20";
        textEl.innerText=c+"/280"
    };// ===================== 4ï¸âƒ£ Timeline æ—¶é—´è½´åŒº =====================
    window.loadTimelines=async function(filter="all"){
        let timelines=Utils.getLocal("timelineList");
        try{
            const q=window.query(window.collection(window.db,"timelines"),window.where("isDeleted","==",false));
            const snap=await window.getDocs(q);
            timelines=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
            Utils.setLocal("timelineList",timelines)
        }catch(err){console.warn("æ— æ³•ä»FirebaseåŠ è½½Timelinesï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜",err)}
        let list=timelines;
        if(filter==="fav")list=timelines.filter(d=>d.star);
        else if(filter==="anniversary")list=timelines.filter(d=>d.tags?.includes("çºªå¿µæ—¥"));
        else if(filter==="travel")list=timelines.filter(d=>d.tags?.includes("æ—…è¡Œ"));
        list=list.sort((a,b)=>(new Date(a.date||a.createdAt))-(new Date(b.date||b.createdAt)));
        document.getElementById("timelineList").innerHTML=list.map(d=>{
            const countdown=d.tags?.includes("çºªå¿µæ—¥")?Utils.getDaysUntil(d.date):null;
            return` <div class="timeline-card${d.star?" starred":""}" data-id="${d.id}">
                <div class="timeline-tags">${(d.tags||[]).map((t,i)=>renderTagColored(t,i)).join("")}</div>
                <div class="timeline-content">${Utils.renderContent(d.text,Utils.highlightKeywords.timeline)}</div>
                <div class="timeline-meta">
                    <span class="timeline-date">${Utils.formatDate(d.date)||Utils.formatDate(d.createdAt)} <small class="relative-time">(${Utils.getRelativeTime(d.date||d.createdAt)})</small></span>
                    ${countdown?`<span class="countdown">ğŸ‰ ${countdown}</span>`:""}
                    <span class="timeline-buttons">
                        <button onclick="starTimeline('${d.id}')">${d.star?"â­":"â˜†"}</button>
                        <button onclick="deleteTimeline('${d.id}')">ğŸ—‘ï¸</button>
                        <button onclick="copyTimeline('${d.id}')">ğŸ“‹</button>
                    </span>
                </div>
            </div>`
        }).join("")
    };
    window.saveTimeline=async function(){
        const date=document.getElementById("timelineDate").value;
        const tagRaw=document.getElementById("timelineTagInput").value.trim();
        const text=document.getElementById("timelineText").value.trim();
        if(!date||!text)return Utils.showToast("âŒ æ—¥æœŸå’Œå†…å®¹ä¸èƒ½ä¸ºç©º","error");
        const tags=tagRaw.split(/[#,ï¼Œ\s]+/).filter(Boolean);
        const d={text,tags,date,star:false,createdAt:Date.now(),isDeleted:false};
        const timelines=Utils.getLocal("timelineList");
        timelines.push({...d,id:"local_"+Date.now()});
        Utils.setLocal("timelineList",timelines);
        const firebaseId=await Utils.saveToFirebase("timelines",d);
        loadTimelines();
        if(firebaseId)Utils.showToast("âœ… å·²ä¿å­˜åˆ°äº‘ç«¯");
        else Utils.showToast("âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆäº‘ç«¯åŒæ­¥å¤±è´¥ï¼‰","warning");
        clearTimelineInput()
    };
    window.starTimeline=async function(id){
        await Utils.toggleStar("timelines",id,()=>Utils.getLocal("timelineList"),data=>Utils.setLocal("timelineList",data));
        loadTimelines()
    };
    window.deleteTimeline=async function(id){
        const deleted=await Utils.softDelete("timelines",id,()=>Utils.getLocal("timelineList"),data=>Utils.setLocal("timelineList",data));
        if(deleted)loadTimelines()
    };
    window.copyTimeline=function(id){
        Utils.copyItem(()=>Utils.getLocal("timelineList"),id)
    };
    window.clearTimelineInput=function(){
        document.getElementById("timelineDate").valueAsDate=new Date();
        document.getElementById("timelineTagInput").value="";
        document.getElementById("timelineText").value="";
        updateTimelineCharCount()
    };
    // (é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸ)
    document.getElementById("timelineDate").valueAsDate = new Date();
    
    window.showBatchTimelinePanel=function(){Utils.showToast("ğŸ“¦ æ‰¹é‡ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...","warning")};
    window.highlightTimelineTags=function(){};
    document.getElementById("timelineText")?.addEventListener("paste",function(e){
        if(document.getElementById("timelinePlainPaste")?.checked){
            e.preventDefault();
            const text=(e.clipboardData||window.clipboardData).getData("text");
            document.execCommand("insertText",false,text)
        }
    });
    window.updateTimelineCharCount=function(){
        const tagEl = document.getElementById("timelineTagCount");
        const textEl = document.getElementById("timelineTextCount");
        if (!tagEl || !textEl) return;
        
        const t=document.getElementById("timelineTagInput").value.length;
        const c=document.getElementById("timelineText").value.length;
        tagEl.innerText=t+"/20";
        textEl.innerText=c+"/240"
    };

    // ===================== 5ï¸âƒ£ Gallery å›¾ç‰‡æ”¶è—åŒº (v11.0 é”å®šç‰ˆ) =====================
    let currentGalleryList = []; // ç¼“å­˜
    
    // (v11.0 ä¼˜åŒ–)
    window.loadGallery = async function() {
        let imgs = Utils.getLocal('galleryList');
        try {
            const q = window.query(window.collection(window.db,"gallery"), window.where("isDeleted", "==", false));
            const snap = await window.getDocs(q);
            imgs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            Utils.setLocal('galleryList', imgs);
        } catch (err) { console.warn("æ— æ³•ä»FirebaseåŠ è½½Galleryï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜", err); }
        
        currentGalleryList = imgs.sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
        
        renderGalleryTabs(); // ç”¨ *å®Œæ•´* åˆ—è¡¨æ¸²æŸ“ Tabs
        filterGalleryByTag('å…¨éƒ¨'); // é»˜è®¤æ˜¾ç¤º 'å…¨éƒ¨' (å‡½æ•°å†…éƒ¨ä¼šå¤„ç†é”å®š)
    };

    // (v11.0 ä¼˜åŒ–)
    window.renderGalleryTabs = function() {
        let allTags = [...new Set(currentGalleryList.flatMap(img => img.tags || []))];
        
        // â€¼ï¸ å…³é”®ï¼šå¦‚æœæœªè§£é”ï¼Œä¸æ˜¾ç¤ºâ€œé™åˆ¶çº§â€æ ‡ç­¾
        if (!appState.secondUnlocked) {
            allTags = allTags.filter(tag => tag !== appState.restrictedTag);
        }
        
        const tabs = ['å…¨éƒ¨', ...allTags];
        document.getElementById('galleryTabs').innerHTML = tabs.map(tab => 
            `<button class="filter-btn ${tab === 'å…¨éƒ¨' ? 'active' : ''}" onclick="filterGalleryByTag('${tab}')">${tab}</button>`
        ).join('');
    };

    // (v11.0 ä¼˜åŒ–)
    window.filterGalleryByTag = function(tag) {
        let imgs = [...currentGalleryList]; // ä»å®Œæ•´ç¼“å­˜å¼€å§‹
        
        // â€¼ï¸ 1. åº”ç”¨é”å®š
        if (!appState.secondUnlocked) {
            imgs = imgs.filter(img => !img.tags || !img.tags.includes(appState.restrictedTag));
        }
        
        // â€¼ï¸ 2. åº”ç”¨Tab
        if (tag !== 'å…¨éƒ¨') {
            imgs = imgs.filter(img => img.tags?.includes(tag));
        }
        
        // â€¼ï¸ 3. æ¸²æŸ“
        document.getElementById('galleryList').innerHTML = renderGalleryCards(imgs);
        Utils.initLazyLoad();
        
        document.querySelectorAll('#galleryTabs .filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.trim() === tag);
        });
    };
    
    function renderGalleryCards(imgs){
        return imgs.map(d=>{
            const safeDesc=escapeGalleryDesc(d.desc);
            return` <div class="gallery-card${d.star?" starred":""}" data-id="${d.id}"> 
                <div class="gallery-img-container" onclick="Utils.showImageLightbox('${d.url}', '${safeDesc}')"> 
                    ${Utils.renderLazyImage(d.url,safeDesc)} 
                </div> 
                <div class="gallery-desc">${safeDesc}</div> 
                <div class="gallery-tags">${(d.tags||[]).map((t,i)=>renderTagColored(t,i)).join("")}</div> 
                <div class="gallery-meta"> 
                    <button onclick="starGallery('${d.id}')">${d.star?"â­":"â˜†"}</button> 
                    <button onclick="deleteGallery('${d.id}')">ğŸ—‘ï¸</button> 
                    <button onclick="copyGallery('${d.id}')">ğŸ“‹</button> 
                </div> 
            </div>`
        }).join("")
    }window.saveGalleryImage=async function(){
        let url="";
        const fileInput=document.getElementById("galleryUploadInput");
        if(fileInput.files&&fileInput.files.length>0){
            Utils.showToast("ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...");
            url=await Utils.uploadImageToStorage(fileInput.files[0])
        }else{
            url=document.getElementById("galleryLinkInput").value.trim();
            if(!/^https?:\/\//.test(url))return Utils.showToast("âŒ è¯·è¾“å…¥æœ‰æ•ˆå›¾ç‰‡é“¾æ¥æˆ–ä¸Šä¼ æ–‡ä»¶")
        }
        const desc=document.getElementById("galleryDescInput").value.trim();
        const tags=desc.split(/[#,ï¼Œ\s]+/).filter(Boolean);
        const d={url,desc,tags,star:false,createdAt:Date.now(),isDeleted:false};
        const imgs=Utils.getLocal("galleryList");
        imgs.push({...d,id:"local_"+Date.now()});
        Utils.setLocal("galleryList",imgs);
        const firebaseId=await Utils.saveToFirebase("gallery",d);
        loadGallery();
        if(firebaseId)Utils.showToast("âœ… å·²ä¿å­˜åˆ°äº‘ç«¯");
        else Utils.showToast("âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆäº‘ç«¯åŒæ­¥å¤±è´¥ï¼‰","warning");
        clearGalleryInput()
    };
    window.handleGalleryUpload=async function(){
        const fileInput=document.getElementById("galleryUploadInput");
        const files=fileInput.files;
        if(!files||files.length===0)return;
        Utils.showToast(`ğŸ“¤ æ­£åœ¨æ‰¹é‡ä¸Šä¼  ${files.length} å¼ å›¾ç‰‡...`);
        let successCount=0;
        for(let i=0;i<files.length;i++){
            const file=files[i];
            const url=await Utils.uploadImageToStorage(file);
            const d={url,desc:file.name,tags:["æ‰¹é‡ä¸Šä¼ "],star:false,createdAt:Date.now(),isDeleted:false};
            const imgs=Utils.getLocal("galleryList");
            imgs.push({...d,id:"local_"+Date.now()+"_"+i});
            Utils.setLocal("galleryList",imgs);
            await Utils.saveToFirebase("gallery",d);
            successCount++
        }
        loadGallery();
        Utils.showToast(`âœ… æˆåŠŸä¸Šä¼  ${successCount}/${files.length} å¼ å›¾ç‰‡`);
        clearGalleryInput()
    };
    window.addGalleryLink=function(){
        const url=document.getElementById("galleryLinkInput").value.trim();
        if(!url||!/^https?:\/\//.test(url))return Utils.showToast("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥","error");
        const isImage=/\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(url.split("?")[0]);
        if(!isImage){
            if(!confirm("é“¾æ¥å¯èƒ½ä¸æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œæ˜¯å¦ç»§ç»­æ·»åŠ ï¼Ÿ"))return
        }
        try{
            const filename=new URL(url).pathname.split("/").pop();
            document.getElementById("galleryDescInput").value=filename
        }catch(e){
            document.getElementById("galleryDescInput").value="å¤–éƒ¨é“¾æ¥"
        }
        Utils.showToast("âœ… é“¾æ¥å·²å‡†å¤‡ï¼Œè¯·è¡¥å……æè¿°åç‚¹â€œä¿å­˜â€","success")
    };
    window.starGallery=async function(id){
        await Utils.toggleStar("gallery",id,()=>Utils.getLocal("galleryList"),data=>Utils.setLocal("galleryList",data));
        loadGallery()
    };
    window.deleteGallery=async function(id){
        const deleted=await Utils.softDelete("gallery",id,()=>Utils.getLocal("galleryList"),data=>Utils.setLocal("galleryList",data));
        if(deleted)loadGallery()
    };
    window.copyGallery=function(id){
        const img=Utils.getLocal("galleryList").find(i=>i.id===id);
        if(!img)return;
        navigator.clipboard.writeText(img.url||"");
        Utils.showToast("ğŸ“‹ å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶")
    };
    window.clearGalleryInput=function(){
        document.getElementById("galleryUploadInput").value="";
        document.getElementById("galleryLinkInput").value="";
        document.getElementById("galleryDescInput").value="";
        updateGalleryCharCount()
    };
    window.updateGalleryCharCount=function(){
        const counter = document.getElementById("galleryDescCount");
        if (!counter) return;
        const c=document.getElementById("galleryDescInput").value.length;
        counter.innerText=c+"/48"
    };
    window.showBatchGalleryPanel=function(){Utils.showToast("ğŸ“¦ æ‰¹é‡ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...","warning")};

    // ===================== 6ï¸âƒ£ Update æ›´æ–°æ—¥è®°åŒº =====================
    window.loadUpdates=async function(filter="all"){
        let updates=Utils.getLocal("updateList");
        try{
            const q=window.query(window.collection(window.db,"updates"),window.where("isDeleted","==",false));
            const snap=await window.getDocs(q);
            updates=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
            Utils.setLocal("updateList",updates)
        }catch(err){console.warn("æ— æ³•ä»FirebaseåŠ è½½Updatesï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜",err)}
        let list=updates;
        if(filter==="fav")list=updates.filter(d=>d.star);
        else if(filter==="major")list=updates.filter(d=>d.tags?.includes("é‡å¤§"));
        else if(filter==="opt")list=updates.filter(d=>d.tags?.includes("ä¼˜åŒ–"));
        list=list.sort((a,b)=>(new Date(b.date||b.createdAt))-(new Date(a.date||a.createdAt)));
        document.getElementById("updateList").innerHTML=list.map(d=>` 
            <div class="update-card${d.star?" starred":""}" data-id="${d.id}">
                <div class="update-tags">${(d.tags||[]).map((t,i)=>renderTagColored(t,i)).join("")}</div>
                <div class="update-content">${Utils.renderContent(d.text,Utils.highlightKeywords.update)}</div>
                <div class="update-meta">
                    <span class="update-version">${d.version||""}</span>
                    <span class="update-date">${Utils.formatDate(d.date||d.createdAt)}</span>
                    <span class="update-buttons">
                        <button onclick="starUpdate('${d.id}')">${d.star?"â­":"â˜†"}</button>
                        <button onclick="deleteUpdate('${d.id}')">ğŸ—‘ï¸</button>
                        <button onclick="copyUpdate('${d.id}')">ğŸ“‹</button>
                    </span>
                </div>
            </div>`).join("")
    };
    window.saveUpdateLog=async function(){
        const date=document.getElementById("updateDateInput").value;
        const tagRaw=document.getElementById("updateTagInput").value.trim();
        const text=document.getElementById("updateText").value.trim();
        if(!date||!text)return Utils.showToast("âŒ æ—¥æœŸå’Œå†…å®¹ä¸èƒ½ä¸ºç©º","error");
        const tags=tagRaw.split(/[#,ï¼Œ\s]+/).filter(Boolean);
        const updates=Utils.getLocal("updateList");
        const version=Utils.generateVersionNumber(updates);
        const d={text,tags,date,star:false,version,createdAt:Date.now(),isDeleted:false};
        updates.push({...d,id:"local_"+Date.now()});
        Utils.setLocal("updateList",updates);
        const firebaseId=await Utils.saveToFirebase("updates",d);
        loadUpdates();
        if(firebaseId)Utils.showToast("âœ… å·²ä¿å­˜åˆ°äº‘ç«¯");
        else Utils.showToast("âš ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆäº‘ç«¯åŒæ­¥å¤±è´¥ï¼‰","warning");
        clearUpdateInput()
    };
    window.starUpdate=async function(id){
        await Utils.toggleStar("updates",id,()=>Utils.getLocal("updateList"),data=>Utils.setLocal("updateList",data));
        loadUpdates()
    };
    window.deleteUpdate=async function(id){
        const deleted=await Utils.softDelete("updates",id,()=>Utils.getLocal("updateList"),data=>Utils.setLocal("updateList",data));
        if(deleted)loadUpdates()
    };
    window.copyUpdate=function(id){
        Utils.copyItem(()=>Utils.getLocal("updateList"),id)
    };
    window.clearUpdateInput=function(){
        document.getElementById("updateDateInput").valueAsDate=new Date();
        document.getElementById("updateTagInput").value="";
        document.getElementById("updateText").value="";
        updateUpdateCharCount()
    };
    // (é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸ)
    document.getElementById("updateDateInput").valueAsDate = new Date();
    
    window.showBatchUpdatePanel=function(){Utils.showToast("ğŸ“¦ æ‰¹é‡ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...","warning")};
    window.highlightUpdateTags=function(){};
    document.getElementById("updateText")?.addEventListener("paste",function(e){
        if(document.getElementById("diaryPlainPaste")?.checked){ // â€¼ï¸ å¤ç”¨ diary çš„ç²˜è´´è®¾ç½®
            e.preventDefault();
            const text=(e.clipboardData||window.clipboardData).getData("text");
            document.execCommand("insertText",false,text)
        }
    });
    window.updateUpdateCharCount=function(){
        const tagEl = document.getElementById("updateTagCount");
        const textEl = document.getElementById("updateTextCount");
        if (!tagEl || !textEl) return;
        
        const t=document.getElementById("updateTagInput").value.length;
        const c=document.getElementById("updateText").value.length;
        tagEl.innerText=t+"/18";
        textEl.innerText=c+"/160"
    };// ===================== 7ï¸âƒ£ Trash å›æ”¶ç«™åŒº =====================
    window.TRASH_MODULES=[
        {key:"diary",label:"ä¿¡ä»¶",coll:"diaries",get:getLocalDiaries,set:setLocalDiaries},
        {key:"dirty",label:"éªšè¯",coll:"dirties",get:getLocalDirties,set:setLocalDirties},
        {key:"lewd",label:"æ¹¿å¤œ",coll:"lewds",get:getLocalLewds,set:setLocalLewds},
        {key:"timeline",label:"æ—¶é—´è½´",coll:"timelines",get:getLocalTimelines,set:setLocalTimelines},
        {key:"gallery",label:"å›¾ç‰‡",coll:"gallery",get:getLocalGallery,set:setLocalGallery},
        {key:"update",label:"æ—¥è®°",coll:"updates",get:getLocalUpdates,set:setLocalUpdates}
    ];
    let trashCurrent="diary";
    let trashBatchSelected=[];
    
    function capitalize(str){ return str[0].toUpperCase()+str.slice(1); }
    function escapeTrash(str){ return(str||"").replace(/[<>&\"]/g,c=>({"<":"&lt;",">":"&gt;","&":"&amp;","\"":"&quot;"}[c])); }
    
    function daysLeftTip(deletedAt){
        if(!deletedAt)return"";
        const left=30-Math.floor((Date.now()-deletedAt)/864e5);
        if(left<=0)return'<span class="trash-warn-expired">å·²è¿‡æœŸ</span>';
        if(left<=3)return`<span class="trash-warn-urgent">âš ï¸ å‰©ä½™ ${left} å¤©</span>`;
        if(left<=7)return`<span class="trash-warn-soon">å‰©ä½™ ${left} å¤©</span>`;
        return`<span class="trash-warn-normal">å‰©ä½™ ${left} å¤©</span>`
    }
    
    window.renderTrashTabs=function(){
        const stats=Utils.getTrashStats();
        TRASH_MODULES.forEach(mod=>{
            const btn=document.getElementById(`trashTab${capitalize(mod.key)}`);
            if(!btn)return;
            const count=stats[mod.key];
            if(count>0)btn.innerHTML=`${mod.label} <span class="tab-count">${count}</span>`;
            else btn.innerHTML=mod.label
        })
    };
    
    window.switchTrashTab=function(tab){
        trashCurrent=tab;
        renderTrashTabs();
        TRASH_MODULES.forEach(m=>
            document.getElementById(`trashTab${capitalize(m.key)}`)
            .classList.toggle("active",m.key===tab)
        );
        trashBatchSelected=[];
        loadTrashList()
    };
    
    window.loadTrashList=function(){
        const mod=TRASH_MODULES.find(m=>m.key===trashCurrent);
        if(!mod)return;
        let list=(mod.get()||[]).filter(d=>d.isDeleted);
        list=list.sort((a,b)=>(b.deletedAt||0)-(a.deletedAt||0));
        const listEl=document.getElementById("trashCategoryList");
        if(list.length===0)listEl.innerHTML='<div class="empty-list-placeholder">å›æ”¶ç«™æ˜¯ç©ºçš„</div>';
        else listEl.innerHTML=list.map(d=>` 
            <div class="trash-card" data-id="${d.id}">
                <div class="trash-main">
                    <div class="trash-content">${escapeTrash(d.text||d.desc||d.url||"æ— å†…å®¹")}</div>
                    <div class="trash-tags">${(d.tags||[]).map((t,i)=>`<span class="tag">${t}</span>`).join("")}</div>
                    <div class="trash-meta">
                        <span class="trash-date">åˆ é™¤äº: ${Utils.formatDate(d.deletedAt)}</span> 
                        ${daysLeftTip(d.deletedAt)} 
                    </div>
                </div>
                <div class="trash-actions">
                    <button class="trash-btn-restore" onclick="restoreTrash('${d.id}')">æ¢å¤</button>
                    <button class="trash-btn-delete" onclick="deleteForever('${d.id}')">å½»åº•åˆ é™¤</button>
                    <input type="checkbox" class="trash-select" data-id="${d.id}" onchange="toggleTrashBatchSelect('${d.id}',this.checked)">
                </div>
            </div>`).join("");
        updateTrashBatchUI()
    };
    
    window.restoreTrash=async function(id){
        const mod=TRASH_MODULES.find(m=>m.key===trashCurrent);
        if(!mod)return;
        let list=mod.get();
        list=list.map(d=>d.id===id?{...d,isDeleted:false,deletedAt:null}:d);
        mod.set(list);
        const cloudSuccess=await Utils.updateFirebase(mod.coll,id,{isDeleted:false,deletedAt:null});
        loadTrashList();
        if(cloudSuccess)Utils.showToast(`âœ… å·²æ¢å¤åˆ° ${mod.label}`);
        else Utils.showToast(`âš ï¸ å·²æœ¬åœ°æ¢å¤ (äº‘ç«¯åŒæ­¥å¤±è´¥)`,"warning")
    };
    
    window.deleteForever=function(id){
        if(!confirm("å½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼Œç¡®å®šï¼Ÿ"))return;
        const mod=TRASH_MODULES.find(m=>m.key===trashCurrent);
        if(!mod)return;
        let list=mod.get();
        list=list.filter(d=>d.id!==id);
        mod.set(list);
        loadTrashList();
        Utils.showToast("å·²å½»åº•åˆ é™¤")
    };
    
    window.clearCurrentTrash=function(){
        const mod=TRASH_MODULES.find(m=>m.key===trashCurrent);
        const trashItems=(mod.get()||[]).filter(d=>d.isDeleted);
        if(trashItems.length===0)return Utils.showToast("å½“å‰å›æ”¶ç«™ä¸ºç©º","warning");
        const confirmed=confirm(`âš ï¸ è­¦å‘Šï¼šå½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼\nç¡®å®šæ¸…ç©º ${mod.label} å›æ”¶ç«™ (${trashItems.length} æ¡)ï¼Ÿ`);
        if(!confirmed)return;
        let list=mod.get();
        list=list.filter(d=>!d.isDeleted);
        mod.set(list);
        loadTrashList();
        Utils.showToast(`âœ… å·²æ¸…ç©º ${mod.label} å›æ”¶ç«™`)
    };
    
    window.toggleTrashBatchSelect=function(id,checked){
        if(checked)trashBatchSelected.push(id);
        else trashBatchSelected=trashBatchSelected.filter(i=>i!==id);
        updateTrashBatchUI()
    };
    
    function updateTrashBatchUI(){
        const batchBar=document.getElementById("trashBatchActions");
        const count=trashBatchSelected.length;
        document.getElementById("trashBatchCount").innerText=count?`å·²é€‰ ${count} æ¡`:"";
        batchBar.style.display=count?"flex":"none"
    }
    
    window.toggleSelectAll=function(){
        const checkboxes=document.querySelectorAll(".trash-select");
        const allChecked=checkboxes.length>0&&Array.from(checkboxes).every(cb=>cb.checked);
        checkboxes.forEach(cb=>{
            cb.checked=!allChecked;
            toggleTrashBatchSelect(cb.dataset.id,cb.checked)
        })
    };
    
    window.batchRestoreTrash=async function(){
        const count=trashBatchSelected.length;
        if(count===0)return;
        const mod=TRASH_MODULES.find(m=>m.key===trashCurrent);
        if(!confirm(`ç¡®å®šæ¢å¤é€‰ä¸­çš„ ${count} æ¡æ•°æ®ï¼Ÿ`))return;
        Utils.showToast(`æ­£åœ¨æ¢å¤ ${count} æ¡...`);
        let list=mod.get();
        list=list.map(d=>trashBatchSelected.includes(d.id)?{...d,isDeleted:false,deletedAt:null}:d);
        mod.set(list);
        for(const id of trashBatchSelected){
            await Utils.updateFirebase(mod.coll,id,{isDeleted:false,deletedAt:null})
        }
        trashBatchSelected=[];
        loadTrashList();
        Utils.showToast(`âœ… å·²æ¢å¤ ${count} æ¡æ•°æ®`)
    };
    
    window.batchDeleteTrash=async function(){
        const count=trashBatchSelected.length;
        if(count===0)return;
        const confirmed=confirm(`âš ï¸ è­¦å‘Šï¼šå½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼\nç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${count} æ¡æ•°æ®ï¼Ÿ`);
        if(!confirmed)return;
        Utils.showToast(`æ­£åœ¨åˆ é™¤ ${count} æ¡...`);
        let list=mod.get();
        list=list.filter(d=>!trashBatchSelected.includes(d.id));
        mod.set(list);
        trashBatchSelected=[];
        loadTrashList();
        Utils.showToast(`âœ… å·²å½»åº•åˆ é™¤ ${count} æ¡æ•°æ®`)
    };// ===================== 8ï¸âƒ£ Egg/å½©è›‹åŒº =====================
    // (é‡‡çº³ â‘¤ ä¼˜åŒ–) é¢„è®¾æ¨¡æ¿
    const EGG_TEMPLATES={
        girlGroup:{
            title:"å¥³å›¢é¡µ",emoji:"ğŸ¤",type:"html",
            content:'<div style="padding:2em 1em;text-align:center;"><h2>ğŸ¤ æˆ‘çš„å¥³å›¢æ”¶è—</h2><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:16px;margin-top:20px;"><div class="member-card"><img src="https://via.placeholder.com/100" style="width:80%;border-radius:50%;"><div style="margin-top:8px;font-weight:bold;">æˆå‘˜1</div></div><div class="member-card"><img src="https://via.placeholder.com/100" style="width:80%;border-radius:50%;"><div style="margin-top:8px;font-weight:bold;">æˆå‘˜2</div></div></div></div>'
        },
        countdown:{
            title:"å€’è®¡æ—¥",emoji:"â°",type:"html",
            content:'<div style="padding:2em 1em;text-align:center;"><h2>â° é‡è¦æ—¥æœŸå€’è®¡æ—¶</h2><div id="countdownDisplay" style="font-size:2em;margin:20px 0;color:var(--accent);"></div><script>(function(){ const targetDate = new Date("2025-12-31T00:00:00"); function update(){ const now = new Date(); const diff = targetDate - now; const days = Math.floor(diff / (1000 * 60 * 60 * 24)); const el = document.getElementById("countdownDisplay"); if(el) el.innerText = days > 0 ? "è¿˜æœ‰ " + days + " å¤©" : "å·²åˆ°è¾¾ï¼"; }; update(); setInterval(update, 1000*60); })();<\/script></div>'
        },
        loveCalculator:{
            title:"çˆ±æƒ…è®¡ç®—å™¨",emoji:"ğŸ’•",type:"html",
            content:'<div style="padding:2em 1em;text-align:center;"><h2>ğŸ’• çˆ±æƒ…åŒ¹é…åº¦è®¡ç®—</h2><input type="text" id="name1" placeholder="ä½ çš„åå­—" style="margin:8px;padding:8px;"><input type="text" id="name2" placeholder="TAçš„åå­—" style="margin:8px;padding:8px;"><button class="qq-btn primary" onclick="calcLove()">è®¡ç®—</button><div id="loveResult" style="margin-top:20px;font-size:1.5em;"></div><script>function calcLove(){const n1 = document.getElementById("name1").value; const n2 = document.getElementById("name2").value; if (!n1 || !n2) return; const hash = (n1 + n2).split("").reduce((a,c) => a + c.charCodeAt(0), 0); const match = 80 + (hash % 20); document.getElementById("loveResult").innerHTML = \'ğŸ’– åŒ¹é…åº¦ï¼š<span style="color:var(--accent);font-weight:bold;">\' + match + "%</span>";}<\/script></div>'
        }
    };
    // (é‡‡çº³ â‘¡ ä¼˜åŒ–) å¯†ç ç¼“å­˜
    const eggPasswordCache={};
    
    // (é‡‡çº³ â‘¡ ä¼˜åŒ–) å¯†ç éªŒè¯
    function verifyEggPassword(id,correctPwd){
        if(eggPasswordCache[id])return true; // æ£€æŸ¥ç¼“å­˜
        const userPwd=prompt("ğŸ”’ æ­¤å½©è›‹é¡µéœ€è¦å¯†ç ï¼š");
        if(userPwd===correctPwd){
            eggPasswordCache[id]=true; // ç¼“å­˜
            return true
        }
        Utils.showToast("âŒ å¯†ç é”™è¯¯","error");
        return false
    }
    
    // (é‡‡çº³ â‘  â‘¢ ä¼˜åŒ–) æ¸²æŸ“å½©è›‹ Tab
    window.loadEggTabs=function(){
        let eggs=getLocalEggs();
        if(eggs.length===0){
            // å¦‚æœä¸€ä¸ªå½©è›‹éƒ½æ²¡æœ‰ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
            const firstEgg={id:"egg_init",title:"æˆ‘çš„ç¬¬ä¸€ä¸ªå½©è›‹",emoji:"ğŸ¥š",type:"html",content:'<h3>æ¬¢è¿ä½¿ç”¨å½©è›‹åŒºï¼</h3><p>ç‚¹å‡» Tab ä¸Šçš„ âœï¸ æŒ‰é’®æ¥ç¼–è¾‘æˆ‘ã€‚</p>',hidden:false,pwd:""};
            eggs=[firstEgg];
            setLocalEggs(eggs)
        }
        
        const tabHtml=eggs.map((egg,i)=>` 
            <div class="egg-tab-wrapper" draggable="true" style="display:inline-block;position:relative;margin:4px;"> 
                <button 
                    class="egg-tab" 
                    id="egg-tab-${egg.id}"
                    onclick="switchEggTab('${egg.id}', event)"
                    style="${egg.color?"background:"+egg.color+";":""}"
                > 
                    ${egg.emoji||"ğŸ¥š"} ${egg.title||"å½©è›‹"+(i+1)} 
                </button> 
                <div class="egg-tab-actions" style="position:absolute;top:-8px;right:-8px;display:none;"> 
                    <button onclick="editEggPage('${egg.id}')" title="ç¼–è¾‘">âœï¸</button> 
                    <button onclick="deleteEggPage('${egg.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button> 
                </div> 
            </div>`).join("");
        
        document.getElementById("eggTabs").innerHTML=tabHtml;
        
        // (é‡‡çº³ â‘¢ ä¼˜åŒ–) æ‚¬åœæ˜¾ç¤º
        document.querySelectorAll(".egg-tab-wrapper").forEach(wrapper=>{
            wrapper.addEventListener("mouseenter",()=>{wrapper.querySelector(".egg-tab-actions").style.display="flex"});
            wrapper.addEventListener("mouseleave",()=>{wrapper.querySelector(".egg-tab-actions").style.display="none"})
        });

        // (é‡‡çº³ â‘£ ä¼˜åŒ–) åˆå§‹åŒ–æ‹–æ‹½
        Utils.initEggTabDrag();
        
        // è‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€ä¸ª (å¦‚æœ panel ä¸ºç©º)
        if(eggs.length>0&&document.getElementById("eggPanel").innerHTML==="") {
            // ç”¨ setTimeout ç¡®ä¿ click äº‹ä»¶èƒ½æ­£ç¡®æ‰¾åˆ° active å…ƒç´ 
            setTimeout(() => switchEggTab(eggs[0].id), 0);
        }
    };
    
    // (é‡‡çº³ â‘  â‘¡ ä¼˜åŒ–) åˆ‡æ¢å½©è›‹
    window.switchEggTab=async function(id, event){
        let eggs=getLocalEggs();
        const egg=eggs.find(e=>e.id===id);
        if(!egg)return;
        
        // (é‡‡çº³ â‘¡) å¯†ç éªŒè¯
        if(egg.pwd&&!verifyEggPassword(egg.id,egg.pwd))return;
        
        let html="";
        
        // (é‡‡çº³ â‘ )
        if(egg.type==="html"){
            html=egg.content;
        } else if(egg.type==="markdown"){
            try {
                await Utils.loadMarked();
                html=marked.parse(egg.content||"");
            } catch (e) {
                console.error("Marked.js åŠ è½½å¤±è´¥", e);
                html = "Markdown æ¸²æŸ“å™¨åŠ è½½å¤±è´¥";
            }
        } else if(egg.type==="img"){
            html=`<img src="${egg.content}" style="max-width:90%;border-radius:12px;" onclick="Utils.showImageLightbox('${egg.content}', '${egg.title}')">`;
        } else if(egg.type==="gallery"){
            const imgs=(egg.content||"").split("\n").filter(Boolean);
            html=` <div class="egg-gallery"> ${imgs.map(url=>` <img src="${url}" style="width:100%;border-radius:8px;cursor:pointer;" onclick="Utils.showImageLightbox('${url}', '')"> `).join("")} </div>`
        } else { // é»˜è®¤ä¸º text
            html=`<pre style="white-space:pre-wrap;padding:1em;background:var(--card);border-radius:8px;">${Utils.escapeHtml(egg.content||"")}</pre>`;
        }
        
        document.getElementById("eggPanel").innerHTML=html;
        
        // æ›´æ–° Tab æ¿€æ´»çŠ¶æ€
        document.querySelectorAll(".egg-tab").forEach(tab=>{tab.classList.remove("active")});
        const activeTab=document.getElementById(`egg-tab-${id}`);
        if(activeTab)activeTab.classList.add("active");
    };

    // (é‡‡çº³ â‘¤ ä¼˜åŒ–) æ–°å¢å½©è›‹
    window.addEggPage=function(){
        const useTemplate=confirm("æ˜¯å¦ä½¿ç”¨é¢„è®¾æ¨¡æ¿ï¼Ÿï¼ˆå–æ¶ˆåˆ™æ‰‹åŠ¨åˆ›å»ºï¼‰");
        let newEgg=null;

        if(useTemplate){
            const templates=Object.keys(EGG_TEMPLATES);
            const choice=prompt(
                'é€‰æ‹©æ¨¡æ¿ï¼š\n' + 
                templates.map((key,i)=>`${i+1}. ${EGG_TEMPLATES[key].title}`).join("\n")
            );
            const index=parseInt(choice)-1;
            if(index>=0&&index<templates.length){
                const template=EGG_TEMPLATES[templates[index]];
                newEgg={...template} // å¤åˆ¶æ¨¡æ¿
            }
        }else{
            // æ‰‹åŠ¨åˆ›å»º
            const title=prompt("æ–°å½©è›‹é¡µåï¼Ÿ","æ–°å½©è›‹");
            if(title===null)return; // ç”¨æˆ·å–æ¶ˆ
            const emoji=prompt("emojiå›¾æ ‡ï¼Ÿ","ğŸ¥š");
            newEgg={title,emoji,type:"html",content:"<h3>æ–°å½©è›‹</h3><p>ç‚¹å‡» âœï¸ ç¼–è¾‘å†…å®¹</p>"}
        }

        if(newEgg){
            let eggs=getLocalEggs();
            newEgg.id="egg_"+Date.now();
            newEgg.hidden=false;
            newEgg.pwd="";
            
            eggs.push(newEgg);
            setLocalEggs(eggs);
            loadEggTabs();
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿ Tab æ¸²æŸ“å®Œæ¯•
            setTimeout(() => switchEggTab(newEgg.id), 0);
        }
    };
    
    // (é‡‡çº³ â‘¢ ä¼˜åŒ–) ç¼–è¾‘
    window.editEggPage=function(id){
        let eggs=getLocalEggs();
        const egg=eggs.find(e=>e.id===id);
        if(!egg)return;
        
        const newTitle=prompt("ä¿®æ”¹æ ‡é¢˜ï¼š",egg.title);
        if(newTitle===null)return; // ç”¨æˆ·å–æ¶ˆ
        
        const newEmoji=prompt("ä¿®æ”¹å›¾æ ‡ï¼š",egg.emoji);
        const newType=prompt("å†…å®¹ç±»å‹ (html/markdown/img/gallery/text)ï¼š",egg.type);
        const newContent=prompt("ä¿®æ”¹å†…å®¹ (å¦‚æœæ˜¯gallery, åˆ™æ¯è¡Œä¸€ä¸ªå›¾ç‰‡URL)ï¼š",egg.content);
        const newPwd=prompt("è®¾ç½®å¯†ç  (ç•™ç©ºåˆ™ä¸åŠ å¯†)ï¼š",egg.pwd);
        
        egg.title=newTitle;
        egg.emoji=newEmoji;
        egg.type=newType;
        egg.content=newContent;
        egg.pwd=newPwd;
        
        if(newPwd)eggPasswordCache[id]=false; // å¦‚æœä¿®æ”¹äº†å¯†ç ï¼Œæ¸…é™¤ç¼“å­˜

        eggs=eggs.map(e=>e.id===id?egg:e);
        setLocalEggs(eggs);
        
        loadEggTabs();
        setTimeout(() => switchEggTab(id), 0);
        Utils.showToast("âœ… å·²æ›´æ–°")
    };

    // (é‡‡çº³ â‘¢ ä¼˜åŒ–) åˆ é™¤
    window.deleteEggPage=function(id){
        if(!confirm("ç¡®å®šåˆ é™¤æ­¤å½©è›‹é¡µï¼Ÿ"))return;
        
        let eggs=getLocalEggs();
        eggs=eggs.filter(e=>e.id!==id);
        setLocalEggs(eggs);
        
        loadEggTabs();
        document.getElementById("eggPanel").innerHTML="" // æ¸…ç©º
    };
    
    // (é‡‡çº³ â‘¥ ä¼˜åŒ–) å¯¼å…¥/å¯¼å‡º
    window.exportEggs=function(){
        const eggs=getLocalEggs();
        const json=JSON.stringify(eggs,null,2);
        const blob=new Blob([json],{type:"application/json"});
        const url=URL.createObjectURL(blob);
        
        const a=document.createElement("a");
        a.href=url;
        a.download=`lovebook_eggs_backup_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        Utils.showToast("âœ… å·²å¯¼å‡º")
    };

    window.importEggs=function(){
        const input=document.createElement('input');
        input.type='file';
        input.accept='.json';
        
        input.onchange=e=>{
            const file=e.target.files[0];
            if(!file)return;
            
            const reader=new FileReader;
            reader.onload=event=>{
                try{
                    const imported=JSON.parse(event.target.result);
                    
                    if(!Array.isArray(imported)){
                        return Utils.showToast("âŒ æ ¼å¼é”™è¯¯","error")
                    }
                    
                    const eggs=getLocalEggs();
                    // ç®€å•åˆå¹¶ï¼Œæœªæ¥å¯åšIDå†²çªæ£€æŸ¥
                    const newEggs=[...eggs,...imported];
                    setLocalEggs(newEggs);
                    
                    loadEggTabs();
                    Utils.showToast(`âœ… å·²å¯¼å…¥ ${imported.length} ä¸ªå½©è›‹é¡µ`)
                }catch(err){
                    Utils.showToast("âŒ å¯¼å…¥å¤±è´¥","error");
                    console.error(err)
                }
            };
            reader.readAsText(file)
        };
        
        input.click()
    };// ===================== 9ï¸âƒ£ Panelæµ®çª—åŒº =====================
    
    // (ä¸º â‘¤ ä¼˜åŒ–) å®šä¹‰æ”¶è—æ¨¡å—é…ç½®
    const FAVORITE_MODULES={
        diary:{get:getLocalDiaries,set:setLocalDiaries,coll:"diaries",label:"ä¿¡ä»¶"},
        dirty:{get:getLocalDirties,set:setLocalDirties,coll:"dirties",label:"éªšè¯"},
        lewd:{get:getLocalLewds,set:setLocalLewds,coll:"lewds",label:"æ¹¿å¤œ"},
        timeline:{get:getLocalTimelines,set:setLocalTimelines,coll:"timelines",label:"æ—¶é—´è½´"},
        gallery:{get:getLocalGallery,set:setLocalGallery,coll:"gallery",label:"å›¾ç‰‡"},
        update:{get:getLocalUpdates,set:setLocalUpdates,coll:"updates",label:"æ—¥è®°"}
    };
    
    // (é‡‡çº³ â‘  ä¼˜åŒ–) Panelé®ç½©ä¸å¼€å…³
    function openPanel(panelId){
        const mask=document.getElementById("panelMask");
        const panel=document.getElementById(panelId);
        if (!mask || !panel) return;

        // å…ˆæ˜¾ç¤ºé®ç½©ï¼ˆæ·¡å…¥ï¼‰
        mask.style.display="block";
        setTimeout(()=>mask.classList.add("show"),10);
        
        // å†æ˜¾ç¤ºé¢æ¿ï¼ˆæ»‘å…¥ï¼‰
        panel.classList.remove("hidden");
        panel.style.display="block"; // è¦†ç›– .hidden
        setTimeout(()=>panel.classList.add("show"),10)
    }
    
    window.closeAnyPanel=function(){
        const mask=document.getElementById("panelMask");
        const panels=document.querySelectorAll(".floating-panel");
        
        if (mask) mask.classList.remove("show");
        panels.forEach(p=>p.classList.remove("show"));
        
        // åŠ¨ç”»ç»“æŸåéšè—
        setTimeout(()=>{
            if (mask) mask.style.display="none";
            panels.forEach(p=>{
                p.classList.add("hidden");
                p.style.display="none" // ç¡®ä¿éšè—
            })
        },300) // å¿…é¡»ä¸ CSS transition æ—¶é—´ä¸€è‡´
    };
    window.closeRandomLetterPanel=function(){closeAnyPanel()};
    window.closeFavoriteRankPanel=function(){closeAnyPanel()};
    
    // (é‡‡çº³ â‘¢ ä¼˜åŒ–) éšæœºä¿¡ä»¶
    window.showRandomLetter=function(){
        const pool=(getLocalDiaries()||[]).filter(d=>!d.isDeleted);
        if(pool.length===0){
            return Utils.showToast("âŒ æš‚æ— ä¿¡ä»¶","error")
        }
        
        const d=pool[Math.floor(Math.random()*pool.length)];
        const contentEl=document.getElementById("randomLetterContent");
        if (!contentEl) return;

        contentEl.innerHTML=` 
            <div style="padding:1em;">
                <h3 style="text-align:center;margin-bottom:16px;">ğŸ² éšæœºä¿¡ä»¶</h3> 
                ${d.tags&&d.tags.length>0?`
                <div style="margin-bottom:12px;"> 
                    ${d.tags.map((t,i)=>`<span class="tag" style="background:${Utils.tagColors[i%Utils.tagColors.length]};color:#fff;padding:4px 10px;border-radius:8px;margin-right:6px;">${t}</span>`).join("")} 
                </div>`:""} 
                <div style="font-size:1.15em;line-height:1.6;padding:20px;background:var(--bg);border-radius:12px;margin:16px 0;max-height: 40vh; overflow-y: auto;"> 
                    ${Utils.renderContent(d.text||"")} 
                </div> 
                <div style="text-align:right;color:var(--muted);margin-top:12px;"> 
                    ${d.from==="Alice"?"ğŸ’‹ Alice":"ğŸ’™ æˆ‘"} Â· 
                    ${d.date||Utils.formatDate(d.createdAt)} 
                </div> 
                <div style="display:flex;gap:12px;margin-top:20px;justify-content:center;"> 
                    <button onclick="showRandomLetter()" class="qq-btn primary">ğŸ² å†æŠ½ä¸€æ¬¡</button> 
                    <button onclick="closeRandomLetterPanel()" class="qq-btn secondary">âŒ å…³é—­</button> 
                </div> 
            </div>`;
        
        // åªæœ‰åœ¨é¢æ¿æœªæ‰“å¼€æ—¶æ‰è°ƒç”¨ openPanel
        if(document.getElementById("randomLetterPanel").classList.contains("hidden")){
            openPanel("randomLetterPanel")
        }
    };
    
    // (é‡‡çº³ â‘¡ â‘¤ â‘¥ ä¼˜åŒ–) æœ€çˆ±æ’è¡Œæ¦œ
    window.showFavoriteRanking=function(tab="diary"){
        openPanel("favoriteRankPanel");
        switchFavoriteTab(tab)
    };
    
    window.switchFavoriteTab=function(tab){
        document.querySelectorAll(".favorite-tabs .filter-btn").forEach(btn=>btn.classList.remove("active"));
        const activeBtn = document.getElementById("favTab"+Utils.capitalize(tab));
        if (activeBtn) activeBtn.classList.add("active");
        renderFavoriteRankList(tab)
    };
    
    function renderFavoriteRankList(tab){
        const mod=FAVORITE_MODULES[tab];
        if(!mod)return;
        
        const list=(mod.get()||[]).filter(d=>d.star&&!d.isDeleted).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
        
        const contentEl=document.getElementById("favoriteRankContent");
        if (!contentEl) return;
        
        // (é‡‡çº³ â‘¥ ç©ºçŠ¶æ€)
        if(list.length===0){
            const emptyStates={
                diary:{emoji:"ğŸ’Œ",text:"è¿˜æ²¡æœ‰æ”¶è—ä¿¡ä»¶å‘¢ï½",action:"å»å†™ä¸€å°"},
                dirty:{emoji:"ğŸ’¬",text:"è¿˜æ²¡æœ‰æ”¶è—éªšè¯å‘¢ï½",action:"å»æ·»åŠ "},
                lewd:{emoji:"ğŸ–¤",text:"è¿˜æ²¡æœ‰æ”¶è—æ¹¿å¤œå‘¢ï½",action:"å»è®°å½•"},
                timeline:{emoji:"ğŸ•°ï¸",text:"è¿˜æ²¡æœ‰æ”¶è—äº‹ä»¶å‘¢ï½",action:"å»æ·»åŠ "},
                gallery:{emoji:"ğŸ–¼ï¸",text:"è¿˜æ²¡æœ‰æ”¶è—å›¾ç‰‡å‘¢ï½",action:"å»ä¸Šä¼ "},
                update:{emoji:"ğŸ“˜",text:"è¿˜æ²¡æœ‰æ”¶è—æ—¥è®°å‘¢ï½",action:"å»è®°å½•"}
            };
            const state=emptyStates[tab] || { emoji: 'â­', text: 'æš‚æ— æ”¶è—', action: 'å»æ·»åŠ ' };
            contentEl.innerHTML=` 
                <div class="panel-empty-state"> 
                    <div class="emoji">${state.emoji}</div> 
                    <div class="text">${state.text}</div> 
                    <button 
                        onclick="closeFavoriteRankPanel(); routeTo('${tab}Content')" 
                        class="qq-btn primary"
                    > 
                        ${state.action} â†’ 
                    </button> 
                </div>`;
            return
        }
        
        // (é‡‡çº³ â‘¡ æ¸²æŸ“)
        const html=list.map((d,index)=>{
            let content="";
            if(tab==="gallery"){
                content=`<img src="${d.url}" style="max-width:100%;border-radius:8px;margin-bottom:8px;">`
            } else {
                content=Utils.renderContent(d.text||d.desc||"")
            }
            
            const tags=(d.tags||[]).map((t,i)=>`<span class="tag" style="background:${Utils.tagColors[i%Utils.tagColors.length]};color:#fff;padding:2px 8px;border-radius:6px;margin-right:4px;">${t}</span>`).join("");
            
            return` 
                <div class="fav-rank-card rank-${index+1}"> 
                    <div class="fav-rank-badge">${index+1}</div> 
                    <div class="fav-content">${content}</div> 
                    ${tags?`<div class="fav-tags">${tags}</div>`:""} 
                    <div class="fav-meta"> 
                        <span>${d.date||Utils.formatDate(d.createdAt)}</span> 
                        <button 
                            onclick="unstarItem('${tab}','${d.id}')" 
                            class="qq-btn secondary"
                        > 
                            å–æ¶ˆ â­ 
                        </button> 
                    </div> 
                </div>`
        }).join("");
        
        contentEl.innerHTML=html
    }
    
    // (é‡‡çº³ â‘¤ ä¼˜åŒ–)
    window.unstarItem=async function(tab,id){
        const mod=FAVORITE_MODULES[tab];
        if(!mod)return;
        
        let list=mod.get();
        list=list.map(d=>d.id===id?{...d,star:false}:d);
        mod.set(list); // 1. æ›´æ–°æœ¬åœ°ç¼“å­˜
        
        // 2. åŒæ­¥åˆ° Firebase
        const cloudSuccess=await Utils.updateFirebase(mod.coll,id,{star:false});
        
        // 3. é‡æ–°æ¸²æŸ“æ’è¡Œæ¦œ
        renderFavoriteRankList(tab);
        
        // 4. (é‡è¦) é‡æ–°åŠ è½½ä¸»é¡µé¢çš„æ•°æ® (å¦‚æœå®ƒå½“å‰å¯è§)
        const mainListLoader=window["load"+Utils.capitalize(tab)+"s"];
        if(typeof mainListLoader==="function") {
            // æ£€æŸ¥é¡µé¢æ˜¯å¦å¯è§
            const page = document.getElementById(tab + 'Content');
            if (page && !page.classList.contains('hidden')) {
                mainListLoader(); // ç«‹å³åˆ·æ–°ä¸»é¡µçš„åˆ—è¡¨
            }
        }
        
        if(cloudSuccess)Utils.showToast("âœ… å·²å–æ¶ˆæ”¶è—");
        else Utils.showToast("âš ï¸ å·²æœ¬åœ°å–æ¶ˆ (äº‘ç«¯åŒæ­¥å¤±è´¥)","warning")
    };// ===================== ğŸ”Ÿ å…¨å±€æœç´¢æ¡ =====================
    
    // (é‡‡çº³ â‘£ ä¼˜åŒ–) ç­›é€‰å™¨å­˜æ ¹
    const searchFilters={
        type:"all",
        starred:false,
    };
    
    // (é‡‡çº³ â‘£ ä¼˜åŒ–) æ•°æ®èšåˆ
    function gatherAllSearchData(){
        let data=[
            ...(getLocalDiaries()||[]).filter(d=>!d.isDeleted).map(d=>({...d,_type:"ä¿¡ä»¶",_route:"diaryContent"})),
            ...(getLocalDirties()||[]).filter(d=>!d.isDeleted).map(d=>({...d,_type:"éªšè¯",_route:"dirtyContent"})),
            ...(getLocalLewds()||[]).filter(d=>!d.isDeleted).map(d=>({...d,_type:"æ¹¿å¤œ",_route:"lewdContent"})),
            ...(getLocalTimelines()||[]).filter(d=>!d.isDeleted).map(d=>({...d,_type:"æ—¶é—´è½´",_route:"timelineContent"})),
            ...(getLocalGallery()||[]).filter(d=>!d.isDeleted).map(d=>({...d,_type:"å›¾ç‰‡",_route:"galleryContent"})),
            ...(getLocalUpdates()||[]).filter(d=>!d.isDeleted).map(d=>({...d,_type:"æ—¥è®°",_route:"updateContent"})),
        ];
        
        // åº”ç”¨ç­›é€‰
        if(searchFilters.starred)data=data.filter(d=>d.star);
        if(searchFilters.type!=="all")data=data.filter(d=>d._type===searchFilters.type);
        return data
    }
    
    // (é‡‡çº³ â‘¡ ä¼˜åŒ–) å…³é”®è¯é«˜äº®
    function highlightSearch(str,kw){
        if(!kw||!str)return Utils.escapeHtml(str); // è½¬ä¹‰
        // ä¿®æ­£ regexï¼Œé˜²æ­¢ kw åŒ…å«ç‰¹æ®Šå­—ç¬¦
        const regex=new RegExp(`(${kw.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");
        return Utils.escapeHtml(str).replace(regex,'<span class="hl">$1</span>')
    }
    
    // (é‡‡çº³ â‘¡ ä¼˜åŒ–) æ¸²æŸ“æœç´¢ç»“æœ
    function renderSearchResults(groups,keyword){
        const panel=document.getElementById("searchResultPanel");
        if(!panel) return;

        if(Object.keys(groups).length===0){
            panel.innerHTML=` 
                <div class="panel-empty-state" style="padding: 2em 1em;"> 
                    <div class="emoji">ğŸ”</div> 
                    <div class="text">æ²¡æœ‰æ‰¾åˆ° "${Utils.escapeHtml(keyword)}" ç›¸å…³çš„å†…å®¹</div> 
                </div>`;
            panel.style.display="block";
            return
        }
        
        let html="";
        const typeOrder=["ä¿¡ä»¶","éªšè¯","æ¹¿å¤œ","æ—¶é—´è½´","å›¾ç‰‡","æ—¥è®°"];
        const emojiMap={"ä¿¡ä»¶":"ğŸ’Œ","éªšè¯":"ğŸ’¬","æ¹¿å¤œ":"ğŸ–¤","æ—¶é—´è½´":"ğŸ•°ï¸","å›¾ç‰‡":"ğŸ–¼ï¸","æ—¥è®°":"ğŸ“˜"};
        
        for(const type of typeOrder){
            if(!groups[type]||groups[type].length===0)continue;
            
            const items=groups[type];
            const emoji=emojiMap[type]||"ğŸ“„";
            
            html+=` 
                <div class="search-group"> 
                    <div class="search-group-title"> 
                        <span>${emoji} ${type}</span> 
                        <span style="color:var(--muted);font-size:0.9em;">${items.length} æ¡ç»“æœ</span> 
                    </div> 
                    <div class="search-group-list"> `;
            
            items.slice(0,5).forEach(d=>{
                const preview=(d.text||d.desc||d.url||"").substring(0,100);
                const tags=(d.tags||[]).slice(0,3);
                
                html+=` 
                    <div class="search-result-card" onclick="jumpToSearchItem('${d._route}','${d.id}')"> 
                        ${tags.length>0?` 
                        <div style="margin-bottom:6px;"> 
                            ${tags.map(t=>`<span class="tag" style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:6px;font-size:0.85em;margin-right:4px;">${highlightSearch(t,keyword)}</span>`).join("")} 
                        </div>`:""} 
                        
                        <div class="search-result-snippet"> 
                            ${highlightSearch(preview,keyword)}${preview.length>=100?"...":""} 
                        </div> 
                        
                        <div class="search-result-date"> 
                            ${d.date||Utils.formatDate(d.createdAt)} 
                        </div> 
                    </div>`
            });
            
            if(items.length>5)html+=`<div class="search-more" onclick="jumpToModule('${items[0]._route}')">æŸ¥çœ‹å…¨éƒ¨ ${items.length} æ¡ ${type} â†’</div>`;
            html+=`</div></div>`
        }
        
        panel.innerHTML=html;
        panel.style.display="block"
    }
    
    // (é‡‡çº³ â‘¢ ä¼˜åŒ–) æ˜¾ç¤ºæœç´¢å†å²
    function showSearchHistory(){
        const panel=document.getElementById("searchResultPanel");
        if (!panel) return;
        const history=Utils.getSearchHistory();
        
        if(history.length===0){
            panel.style.display="none";
            return
        }
        
        const html=` 
            <div style="padding:12px;"> 
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;color:var(--muted);font-size:0.9em;"> 
                    <span>ğŸ• æœç´¢å†å²</span> 
                    <button onclick="Utils.clearSearchHistory()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.9em;"> 
                        æ¸…ç©º 
                    </button> 
                </div> 
                ${history.map(kw=>` 
                <div class="history-item" onclick="document.getElementById('globalSearchInput').value='${kw}';doGlobalSearch('${kw}');"> 
                    ğŸ” ${Utils.escapeHtml(kw)} 
                </div>`).join("")} 
            </div>`;
        
        panel.innerHTML=html;
        panel.style.display="block"
    }
    
    // (é‡‡çº³ â‘  â‘¡ â‘¢ ä¼˜åŒ–) æ ¸å¿ƒæœç´¢å‡½æ•°
    window.doGlobalSearch=function(val){
        val=(val||"").trim();
        const panel=document.getElementById("searchResultPanel");
        const clearBtn=document.getElementById("searchClearBtn");
        if (!panel || !clearBtn) return;

        if(!val){
            clearBtn.style.display="none";
            showSearchHistory(); // æ˜¾ç¤ºå†å²
            return
        }
        
        clearBtn.style.display="inline-block";
        Utils.addSearchHistory(val); // è®°å½•å†å²
        
        const all=gatherAllSearchData();
        const results=Utils.smartSearch(all,val); // æ™ºèƒ½æœç´¢
        
        const groups={};
        results.forEach(d=>{
            if(!groups[d._type])groups[d._type]=[];
            groups[d._type].push(d)
        });
        
        renderSearchResults(groups,val) // æ¸²æŸ“ç»“æœ
    };
    
    // (æœç´¢æ¡æ§åˆ¶)
    window.toggleSearchBar=function(forceClose=false){
        const bar=document.getElementById("globalSearchBar");
        const input=document.getElementById("globalSearchInput");
        const panel=document.getElementById("searchResultPanel");
        const clearBtn = document.getElementById("searchClearBtn");
        if (!bar || !input || !panel || !clearBtn) return;

        if(forceClose||bar.classList.contains("active")){
            bar.classList.remove("active");
            input.value="";
            input.blur(); // å¤±å»ç„¦ç‚¹
            panel.style.display="none";
            clearBtn.style.display="none"
        }else{
            bar.classList.add("active");
            input.focus();
            doGlobalSearch("") // æ‰“å¼€æ—¶æ˜¾ç¤ºå†å²è®°å½•
        }
    };
    
    window.clearGlobalSearch=function(){
        const input = document.getElementById("globalSearchInput");
        if (!input) return;
        input.value="";
        input.focus();
        doGlobalSearch("") // æ¸…ç©ºæ—¶æ˜¾ç¤ºå†å²
    };
    
    window.jumpToSearchItem=function(route,id){
        routeTo(route);
        //  TODO: é«˜äº®å¹¶æ»šåŠ¨åˆ° ID
        setTimeout(()=>{
            // (è¿™æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆçš„é«˜äº®)
            const card=document.querySelector(`[data-id="${id}"]`);
            if(card){
                card.scrollIntoView({behavior:"smooth",block:"center"});
                card.style.transition="all 0.3s ease";
                card.style.boxShadow="0 0 15px var(--accent)";
                setTimeout(()=>card.style.boxShadow="",1500)
            }
        },500); // ç­‰å¾…é¡µé¢æ¸²æŸ“
        toggleSearchBar(true)
    };
    
    window.jumpToModule=function(route){
        routeTo(route);
        toggleSearchBar(true)
    };

    // ================================================
    // ğŸš€ å¯åŠ¨ï¼ (v11.0 æœ€ç»ˆç‰ˆ)
    // ================================================
    (function startup() {
        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('lovebook-theme') || 'theme-blue';
        Utils.setTheme(savedTheme);
        
        // (é‡‡çº³ v11.0 ä¼˜åŒ–) æ‰§è¡Œæ‰“å­—æœºåŠ¨ç”»
        const loginTitle = document.querySelector('#loginBox h1');
        const loginSubtitle = document.querySelector('#loginBox p');
        if (loginTitle && loginSubtitle) {
            const titleText = loginTitle.innerText;
            const subtitleText = loginSubtitle.innerText;
            
            loginTitle.innerText = '';
            loginSubtitle.innerText = '';
            
            Utils.typewriter(loginTitle, titleText, 75, () => {
                // æ ‡é¢˜å®Œæˆåï¼Œå†æ‰“å‰¯æ ‡é¢˜
                Utils.typewriter(loginSubtitle, subtitleText, 50);
            });
        }
    })();



  // ========== è‡ªå®šä¹‰é‡æ„æ¨¡å— ==========
  // ä½¿ç”¨ä¸€ä¸ªé€šç”¨å·¥å‚å‡½æ•°å‡å°‘é‡å¤ä»£ç ï¼Œå¹¶æŒ‚è½½åˆ° window å…¨å±€ï¼Œä¿ç•™åŸæ¥å£åç§°ä»¥å…¼å®¹ HTML
  (function() {
    // å·¥å‚å‡½æ•°ï¼šæ ¹æ®é…ç½®è¿”å›é€šç”¨çš„åŠ è½½ã€æ”¶è—ã€åˆ é™¤ã€å¤åˆ¶å‡½æ•°
    function createCommonModule({ stateKey, collection, elementId, filters, sortBy, renderItem }) {
      return {
        load: async function(filter = 'all') {
          let items = Utils.getLocal(stateKey);
          try {
            const q = window.query(window.collection(window.db, collection), window.where('isDeleted','==', false));
            const snap = await window.getDocs(q);
            items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            Utils.setLocal(stateKey, items);
          } catch(err) {
            console.warn(`æ— æ³•ä»FirebaseåŠ è½½${collection}`, err);
          }
          let list = items;
          if (filter !== 'all' && filters && filters[filter]) list = items.filter(filters[filter]);
          list = list.sort(sortBy);
          const container = document.getElementById(elementId);
          if (container) {
            container.innerHTML = list.map(renderItem).join('');
          }
        },
        star: async function(id) {
          await Utils.toggleStar(collection, id, () => Utils.getLocal(stateKey), data => Utils.setLocal(stateKey, data));
          this.load();
        },
        delete: async function(id) {
          const deleted = await Utils.softDelete(collection, id, () => Utils.getLocal(stateKey), data => Utils.setLocal(stateKey, data));
          if (deleted) this.load();
        },
        copy: function(id) {
          Utils.copyItem(() => Utils.getLocal(stateKey), id);
        }
      };
    }

    // é‡æ„ Diary æ¨¡å—
    const DiaryModule = createCommonModule({
      stateKey: 'diaryList',
      collection: 'diaries',
      elementId: 'diaryList',
      filters: {
        'Alice': d => d.from === 'Alice',
        'Ming': d => d.from === 'Ming',
        'Private': d => d.from === 'Private'
      },
      sortBy: (a,b) => (b.createdAt || 0) - (a.createdAt || 0),
      renderItem: function(d) {
        return `<div class="diary-card${d.star ? ' starred' : ''}${d.locked ? ' locked' : ''}" data-id="${d.id}">` +
          `<div class="diary-tags">${(d.tags || []).map((t, i) => renderTagColored(t, i)).join('')}</div>` +
          `<div class="diary-content">${Utils.renderContent(d.text)}</div>` +
          `<div class="diary-meta">` +
            `<span class="diary-from">${d.from === 'Alice' ? 'ğŸ’‹ Alice' : 'æˆ‘'}</span>` +
            `<span class="diary-date">${new Date(d.createdAt).toLocaleDateString()}</span>` +
            `${d.locked ? '<span class=\"lock-icon\" title=\"é”å®šï¼Œä¸å¯åˆ \">ğŸ”’</span>' : ''}` +
            `<button onclick="starDiary('${d.id}')">${d.star ? 'â­' : 'â˜†'}</button>` +
            `${!d.locked ? `<button onclick=\"deleteDiary('${d.id}')\">ğŸ—‘ï¸</button>` : ''}` +
            `<button onclick="copyDiary('${d.id}')">ğŸ“‹</button>` +
          `</div>` +
        `</div>`;
      }
    });
    // è¦†ç›–åŸæœ‰å‡½æ•°ï¼Œä¿ç•™å¤–éƒ¨æ¥å£ä¸å˜
    window.loadDiaries = DiaryModule.load;
    window.starDiary = DiaryModule.star.bind(DiaryModule);
    window.deleteDiary = DiaryModule.delete.bind(DiaryModule);
    window.copyDiary = DiaryModule.copy.bind(DiaryModule);

    // é‡æ„ Dirty æ¨¡å—
    const DirtyModule = createCommonModule({
      stateKey: 'dirtyList',
      collection: 'dirties',
      elementId: 'dirtyList',
      filters: {
        'fav': d => d.star,
        'group1': d => (d.tags || []).includes('äº²æ˜µ'),
        'group2': d => (d.tags || []).includes('å“„éª—')
      },
      sortBy: (a,b) => (b.createdAt || 0) - (a.createdAt || 0),
      renderItem: function(d) {
        return `<div class="dirty-card${d.star ? ' starred' : ''}" data-id="${d.id}">` +
          `<div class="dirty-tags">${(d.tags || []).map((t, i) => renderTagColored(t, i)).join('')}</div>` +
          `<div class="dirty-content">${Utils.renderContent(d.text)}</div>` +
          `<div class="dirty-meta">` +
            `<button onclick="starDirty('${d.id}')">${d.star ? 'â­' : 'â˜†'}</button>` +
            `<button onclick="deleteDirty('${d.id}')">ğŸ—‘ï¸</button>` +
            `<button onclick="copyDirty('${d.id}')">ğŸ“‹</button>` +
          `</div>` +
        `</div>`;
      }
    });
    window.loadDirties = DirtyModule.load;
    window.starDirty = DirtyModule.star.bind(DirtyModule);
    window.deleteDirty = DirtyModule.delete.bind(DirtyModule);
    window.copyDirty = DirtyModule.copy.bind(DirtyModule);

    // é‡æ„ Lewd æ¨¡å—
    const LewdModule = createCommonModule({
      stateKey: 'lewdList',
      collection: 'lewds',
      elementId: 'lewdList',
      filters: {
        'fav': d => d.star,
        'group1': d => (d.tags || []).includes('ç¾æ¶©'),
        'group2': d => (d.tags || []).includes('ç‚½çƒ­')
      },
      sortBy: (a,b) => (b.createdAt || 0) - (a.createdAt || 0),
      renderItem: function(d) {
        return `<div class="lewd-card${d.star ? ' starred' : ''}" data-id="${d.id}">` +
          `<div class="lewd-tags">${(d.tags || []).map((t, i) => renderTagColored(t, i)).join('')}</div>` +
          `<div class="lewd-content">${Utils.renderContent(d.text, Utils.highlightKeywords.lewd)}</div>` +
          `<div class="lewd-meta">` +
            `<button onclick="starLewd('${d.id}')">${d.star ? 'â­' : 'â˜†'}</button>` +
            `<button onclick="deleteLewd('${d.id}')">ğŸ—‘ï¸</button>` +
            `<button onclick="copyLewd('${d.id}')">ğŸ“‹</button>` +
          `</div>` +
        `</div>`;
      }
    });
    window.loadLewds = LewdModule.load;
    window.starLewd = LewdModule.star.bind(LewdModule);
    window.deleteLewd = LewdModule.delete.bind(LewdModule);
    window.copyLewd = LewdModule.copy.bind(LewdModule);

    // é‡æ„ Timeline æ¨¡å—
    const TimelineModule = createCommonModule({
      stateKey: 'timelineList',
      collection: 'timelines',
      elementId: 'timelineList',
      filters: {
        'fav': d => d.star,
        'anniversary': d => (d.tags || []).includes('çºªå¿µæ—¥'),
        'travel': d => (d.tags || []).includes('æ—…è¡Œ')
      },
      sortBy: (a,b) => new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt),
      renderItem: function(d) {
        const countdown = (d.tags || []).includes('çºªå¿µæ—¥') ? Utils.getDaysUntil(d.date) : null;
        return `<div class="timeline-card${d.star ? ' starred' : ''}" data-id="${d.id}">` +
          `<div class="timeline-tags">${(d.tags || []).map((t, i) => renderTagColored(t, i)).join('')}</div>` +
          `<div class="timeline-content">${Utils.renderContent(d.text, Utils.highlightKeywords.timeline)}</div>` +
          `<div class="timeline-meta">` +
            `<span class="timeline-date">${Utils.formatDate(d.date || d.createdAt)} <small class="relative-time">(${Utils.getRelativeTime(d.date || d.createdAt)})</small></span>` +
            `${countdown ? `<span class=\"countdown\">ğŸ‰ ${countdown}</span>` : ''}` +
            `<span class="timeline-buttons">` +
              `<button onclick="starTimeline('${d.id}')">${d.star ? 'â­' : 'â˜†'}</button>` +
              `<button onclick="deleteTimeline('${d.id}')">ğŸ—‘ï¸</button>` +
              `<button onclick="copyTimeline('${d.id}')">ğŸ“‹</button>` +
            `</span>` +
          `</div>` +
        `</div>`;
      }
    });
    window.loadTimelines = TimelineModule.load;
    window.starTimeline = TimelineModule.star.bind(TimelineModule);
    window.deleteTimeline = TimelineModule.delete.bind(TimelineModule);
    window.copyTimeline = TimelineModule.copy.bind(TimelineModule);

    // é‡æ„ Update æ¨¡å—
    const UpdateModule = createCommonModule({
      stateKey: 'updateList',
      collection: 'updates',
      elementId: 'updateList',
      filters: {
        'fav': d => d.star,
        'major': d => (d.tags || []).includes('é‡å¤§'),
        'opt': d => (d.tags || []).includes('ä¼˜åŒ–')
      },
      sortBy: (a,b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt),
      renderItem: function(d) {
        return `<div class="update-card${d.star ? ' starred' : ''}" data-id="${d.id}">` +
          `<div class="update-tags">${(d.tags || []).map((t, i) => renderTagColored(t, i)).join('')}</div>` +
          `<div class="update-content">${Utils.renderContent(d.text, Utils.highlightKeywords.update)}</div>` +
          `<div class="update-meta">` +
            `<span class="update-version">${d.version || ''}</span>` +
            `<span class="update-date">${Utils.formatDate(d.date || d.createdAt)}</span>` +
            `<span class="update-buttons">` +
              `<button onclick="starUpdate('${d.id}')">${d.star ? 'â­' : 'â˜†'}</button>` +
              `<button onclick="deleteUpdate('${d.id}')">ğŸ—‘ï¸</button>` +
              `<button onclick="copyUpdate('${d.id}')">ğŸ“‹</button>` +
            `</span>` +
          `</div>` +
        `</div>`;
      }
    });
    window.loadUpdates = UpdateModule.load;
    window.starUpdate = UpdateModule.star.bind(UpdateModule);
    window.deleteUpdate = UpdateModule.delete.bind(UpdateModule);
    window.copyUpdate = UpdateModule.copy.bind(UpdateModule);
  })();
})(); // ç«‹å³æ‰§è¡Œè¿™ä¸ªå‡½æ•°
</script>
</body>  
</html>
